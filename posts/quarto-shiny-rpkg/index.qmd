---
title: "Quarto Shiny Apps in R Packages" 
subtitle: "Modules, launching and deployment"
author: "Martin Frigaard"
date: "2025-02-06"
categories: [Quarto, Shiny, Packages]
image: "img/quarto.png"
toc: true
toc-depth: 5
toc-title: 'Contents'
toc-location: "left"
# code-block-border-left: true
code-block-bg: "#f8f8f8"
code-block-border-left: "#e8e8e8"
code-fold: show
code-summary: 'show/hide'
callout-icon: false
draft: false

freeze: true

execute:
  echo: true
  message: false
  warning: false
  eval: false

---

```{r}
#| label: setup
#| eval: true 
#| echo: false 
#| include: false
source("../_common.R")
options(scipen = 999)
library(shiny)
library(lobstr)
library(crayon)
library(stringr)
# install.packages(c("NHANES", "palmerpenguins"))
library(NHANES)
library(palmerpenguins)
library(reticulate)
```

```{r}
#| label: co_box_dev
#| results: asis 
#| echo: false
#| eval: false
co_box(
  color = 'r',
  header = 'Important!',
  size = "1.05",
  hsize = "1.10",
  fold = FALSE,
  look = 'default',
  contents = "This is currently under development. Thank you for your patience."
)
```

This post was prompted by a new chapter I've been working on for Shiny App-Packages. I've recently been building a Shiny application in a Quarto document[^quarto-interactivity], and noticed quite a few deviations from the standard app-package practices that deserve some attention.

I'll cover various dashboard/html layout options, including modules in a Quarto document, and how to create a standalone function to launch your Quarto + Shiny app from an app-package.

[^quarto-interactivity]: Shiny is covered in the [Interactivity section](https://quarto.org/docs/interactive/shiny/) of the Quarto documentation. 

## Set up 

The Quarto document (`index.qmd`) is placed inside the `inst/` folder with a [`_quarto.yml` project file](https://quarto.org/docs/projects/quarto-projects.html#project-metadata): 

```{verbatim}
└── inst
     └── quarto
          ├── _quarto.yml
          └── index.qmd
```

### [`_quarto.yml`]{style="font-size: 1.10em; font-weight: bold;"}

`_quarto.yml` contains metadata on the format, style, and rendering options for the dashboard. 

```yml
title: "Quarto Movies App"

format:
  html:
    embed-resources: true
```

This file includes options for the entire Quarto project (i.e., all `.qmd` files in the folder). In our case it's simply the dashboard file: `index.qmd`.

### [`index.qmd`]{style="font-size: 1.10em; font-weight: bold;"}

The `index.qmd` file contains the `title` of our application and the `format` of the document in the YAML frontmatter. 

{{< include _index_title.qmd >}}

### [`www/`]{style="font-size: 1.10em; font-weight: bold;"}

To include resources (like images or stylesheets), we'll also  add a `www/` folder:

```{verbatim}
└── inst
     └── quarto
          ├── _quarto.yml
          ├── index.qmd
          └── www/
              └── quarto.png
```

### [`context: setup`]{style="font-size: 1.10em; font-weight: bold;"}

The first code chunk in `index.qmd` should include a `context: setup` option and  load the necessary packages. If we want the dashboard to have access to the resources in `www/`, we need to include the [`addResourcePath()` function](https://shiny.posit.co/r/reference/shiny/0.12.0/addresourcepath.html) and pass the path with the installed version of our application. 

{{< include _add_resource_path.qmd >}}

## Dashboards

Dashboard layouts are covered extensively in the Quarto documentation[^quarto-dashs] and elsewhere[^youtube], and I've included example layouts in the [code repo](https://github.com/mjfrigaard/quarto-dash-r). Key things to remember about Quarto dashboard layouts:

### [`format: dashboard`]{style="font-size: 1.10em; font-weight: bold;"}

1. Dashboard layouts are configured using a combination of YAML fields and markdown headings. By default, the `orientation` field is set to `rows`, but multiple code chunks will add new columns:
    
    ```yml
    format: 
      dashboard:
        orientation: columns
    ```
    
2. Level 1 headers create pages (with titles)

    ```markdown
    # Page 1
    ```

3. Level 2 and 3 headers create columns and rows (with height and width options)

    ```markdown
    ## Row {height=20%}

    ### Column {width=35%}
    ```

4. Tabsets can be created `{.tabset}`:

    ```markdown
    ### Column {.tabset}
    ```

5. Inside the columns and rows, cards provide a flexible, grid-based structure for presenting different types of content. Cards are automatically created with text or a code chunk, and they can be labeled with a `title`. Cards can also be included using `{.card}` inside a div (`:::`):

    ```markdown
    #| title: Cost per week
    ```

    ```markdown
    ::: {.card title="Cost per week"}

    :::
    ```

6. To customize the navigation bar in a Quarto dashboard, we can incorporate elements such as a `logo` and `nav-buttons`.

    ```yml
    format:
      dashboard:
        nav-buttons:
          - text: About
            href: https://quarto.org/
          - icon: github
            href: https://github.com/mjfrigaard/quarto-dash-r
          - icon: wikipedia
            target: _blank
            href: https://en.wikipedia.org/wiki/RStudio#Reproducible_analyses_with_vignettes
    ```
    
<!-- {{< include _navbar.qmd >}} -->

::: {.column-margin}

View various layouts in the [GitHub repository.](https://github.com/mjfrigaard/quarto-dash-r) for this post.

:::

Below is an example dashboard layout with most of the features mentioned above. Note that the standard code chunk options are also available (i.e., code echo/folding):

![Quarto layout options page 1 (click to enlarge)](img/layout_p1.png)

![Quarto layout options page 2 (click to enlarge)](img/layout_p2.png)

View the code used for the layout above (and others) in the GitHub repository.[^layouts]

[^layouts]: The [`.qmd` files ending in `layout`](https://github.com/search?q=repo%3Amjfrigaard%2Fquarto-dash-r+path%3A%22layout.qmd%22&type=code) are examples of various dashboard layouts.  

## Reactivity 

Quarto documents can be converted into Shiny's apps using the `server` option in the YAML header. In our `index.qmd` file, we'll set `server` to `shiny`:

### [`server: shiny`]{style="font-size: 1.10em; font-weight: bold;"}

{{< include _shiny_options.qmd >}}



## Modules 

If you're developing a Quarto + Shiny application using modules (and you should[^shiny-mods-1] be[^shiny-mods-2]), the module functions can be placed in the code blocks like regular Shiny code.

The code below is used to implement the UI functions from the `mod_var_input.R` and `mod_scatter_display_ui.R` modules: 

{{< include _shiny_modules.qmd >}}

The `panel: input` creates a '*div with class `.panel-input`* and `panel: center` will '*leave some horizontal margin around its content*.'[^input-panel]

[^input-panel]: Read more about [Input Panel layouts](https://quarto.org/docs/interactive/layout.html#input-panel)

We can also include regular shiny code in code chunks: 

{{< include _shiny_code.qmd >}}

`panel: fill` will '*fill all available spac*e' in the dashboard.[^sidebar-layout]

[^sidebar-layout]: Read more about [Sidebar Panel layouts](https://quarto.org/docs/interactive/layout.html#sidebar-panel).

[^shiny-mods-1]: See the [Modularizing Shiny app code](https://shiny.posit.co/r/articles/improve/modules/) in the Shiny documentation.

[^shiny-mods-2]: See the [Shiny modules chapter](https://mastering-shiny.org/scaling-modules.html) of Mastering Shiny.


### [`context: server`]{style="font-size: 1.10em; font-weight: bold;"}

The `server: shiny` in the YAML frontmatter ensures the document will render the UI inputs (i.e., the contents of `mod_var_input_ui()`). To differentiate the `server` (running on the back-end) code from user inputs and outputs, we need to add the module server functions in code blocks with the `context: server` option: 

{{< include _shiny_module_server.qmd >}}

## Styling

[SASS (Syntactically Awesome Style Sheets)](https://en.wikipedia.org/wiki/Sass_(style_sheet_language)) or [CSS (Cascading Style Sheets)](https://en.wikipedia.org/wiki/CSS) can be powerful tools for customizing a Quarto dashboard's appearance. Unlike standard CSS, SCSS introduces features like variables, nesting, and mixins, which help keep the code organized and modular. 

### [`styles.scss`]{style="font-size: 1.10em; font-weight: bold;"}

A dedicated `.scss` file keeps styles organized and separated from content, improving readability and maintainability. 

```{verbatim}
└── inst
     └── quarto
          ├── _quarto.yml
          ├── index.qmd
          └── www
              ├── quarto.png
              └── styles.scss
```

We will set some colors defaults in `www/styles.scss`:

```scss
/*-- scss:defaults --*/

// colors
$body-bg: #070d35;
$body-color: #FFFFFF;

$link-color: #2ee3a4;
$hover-color: lighten($link-color, 40%);

$code-block-bg-alpha: -.8;

/*-- scss:rules --*/

```

### [`thematic`]{style="font-size: 1.10em; font-weight: bold;"}

For a broader, simplified approach to styling, we can install/use the [`thematic`](https://rstudio.github.io/thematic/) package:

```{r}
#| eval: false
#| code-fold: false
install.packages("thematic")
```

We can add `thematic_set_theme()` to the `context: setup` code chunk in `index.qmd`:

```{r}
#| eval: false
#| code-fold: false
thematic::thematic_set_theme(
  theme = thematic::thematic_theme(
    bg = "#070d35", 
    fg = "#FFFFFF", 
    accent = "#2ee3a4"))
```

This also requires the `shiny.useragg` [option](https://rstudio.github.io/thematic/articles/fonts.html?q=shinyuseragg#shiny-rmd):

```{r}
#| eval: false
#| code-fold: false
options(shiny.useragg = TRUE)
```


## Launching

To launch our Quarto dashboard with a standalone app function, we can use `quarto_preview()` with `system.file()`:

```{r}
#| eval: false 
#| code-fold: false
launch_app <- function() {
  quarto::quarto_preview(
    system.file("quarto", "index.qmd", package = "sap" ), 
    render = "all")
}
```

```{r}
#| eval: false 
#| code-fold: false
launch_app()
```

![Quarto App (click to enlarge)](img/quarto_app.png){width='100%' fig-align='center'}


## Recap

If you're interested in learning more, check out the [Quarto apps section](https://mjfrigaard.github.io/shiny-app-pkgs/resources.html#sec-resources-inst-quarto) of Shiny App-Packages and the [Quarto documentation](). Albert Rapp has a great video on [building interactive apps with Quarto & Shiny](https://youtu.be/06H8k1nzZQ0?si=vGKuE6VX1LdfDMP7) and Isabella Velásquez also does a fantastic job covering [python Quarto dashboards](https://youtu.be/uLGe9zuuNl0?si=8bC7qG3AvFDcmj2x).

[^quarto-dashs]: [Quarto dashboards.](https://quarto.org/docs/dashboards/)

[^youtube]: Mine Çetinkaya-Rundel has an excellent three part tutorial on Posit's YouTube channel ([part 1](https://youtu.be/HW7QbqI4fH0?si=WuBui8y9uRjOVQzD), [part 2](https://www.youtube.com/watch?v=KdsQgwaY950), [part 3](https://www.youtube.com/watch?v=NigWSB-jG4Y&t=112s)).


