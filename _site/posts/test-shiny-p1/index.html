<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Martin Frigaard">
<meta name="dcterms.date" content="2023-05-01">

<title>@mjfrigaard - Unit testing shiny utility functions</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../profile.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<link href="../../site_libs/selectize-0.12.4/css/selectize.bootstrap3.css" rel="stylesheet">
<script src="../../site_libs/selectize-0.12.4/js/selectize.min.js"></script>
<script src="../../site_libs/selectize-0.12.4/accessibility/js/selectize-plugin-a11y.min.js"></script>


<meta name="twitter:title" content="@mjfrigaard - Unit testing shiny utility functions">
<meta name="twitter:description" content="Part 1: Unit tests in shiny app-packages">
<meta name="twitter:image" content="https://mjfrigaard.github.io/posts/test-shiny-p1/image.png">
<meta name="twitter:image-height" content="749">
<meta name="twitter:image-width" content="561">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="floating nav-fixed slimcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title"><span class="citation" data-cites="mjfrigaard">@mjfrigaard</span></span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-blog" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">Blog</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-blog">    
        <li>
    <a class="dropdown-item" href="../../posts.html" rel="" target="">
 <span class="dropdown-text">Posts</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../series.html" rel="" target="">
 <span class="dropdown-text">Series</span></a>
  </li>  
    </ul>
  </li>
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/mjfrigaard" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/mjfrigaard" rel="" target=""><i class="bi bi-twitter" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Unit testing shiny utility functions</h1>
            <p class="subtitle lead">Part 1: Unit tests in shiny app-packages</p>
                                <div class="quarto-categories">
                <div class="quarto-category">shiny</div>
                <div class="quarto-category">testing</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Martin Frigaard </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">May 1, 2023</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Contents</h2>
   
  <ul>
  <li><a href="#shiny-app-packages" id="toc-shiny-app-packages" class="nav-link active" data-scroll-target="#shiny-app-packages">Shiny app-packages</a></li>
  <li><a href="#what-are-unit-tests" id="toc-what-are-unit-tests" class="nav-link" data-scroll-target="#what-are-unit-tests">What are unit tests?</a>
  <ul>
  <li><a href="#testthat" id="toc-testthat" class="nav-link" data-scroll-target="#testthat">testthat</a>
  <ul>
  <li><a href="#test-files" id="toc-test-files" class="nav-link" data-scroll-target="#test-files">Test files</a></li>
  <li><a href="#test-structure" id="toc-test-structure" class="nav-link" data-scroll-target="#test-structure">Test structure</a></li>
  <li><a href="#expectations" id="toc-expectations" class="nav-link" data-scroll-target="#expectations">Expectations</a></li>
  <li><a href="#unit-test-development-workflow" id="toc-unit-test-development-workflow" class="nav-link" data-scroll-target="#unit-test-development-workflow">Unit test development workflow</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#app-utility-functions" id="toc-app-utility-functions" class="nav-link" data-scroll-target="#app-utility-functions">App utility functions</a></li>
  <li><a href="#micro-iteration" id="toc-micro-iteration" class="nav-link" data-scroll-target="#micro-iteration">Micro-iteration</a>
  <ul>
  <li><a href="#function-names" id="toc-function-names" class="nav-link" data-scroll-target="#function-names">Function names</a></li>
  <li><a href="#create-test-file" id="toc-create-test-file" class="nav-link" data-scroll-target="#create-test-file">Create test file</a></li>
  <li><a href="#test-context" id="toc-test-context" class="nav-link" data-scroll-target="#test-context">Test context</a></li>
  <li><a href="#test-data" id="toc-test-data" class="nav-link" data-scroll-target="#test-data">Test data</a></li>
  <li><a href="#expectations-1" id="toc-expectations-1" class="nav-link" data-scroll-target="#expectations-1">Expectations</a>
  <ul>
  <li><a href="#recap-test-data" id="toc-recap-test-data" class="nav-link" data-scroll-target="#recap-test-data">Recap: test data</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#mezzo-iteration" id="toc-mezzo-iteration" class="nav-link" data-scroll-target="#mezzo-iteration">Mezzo-iteration</a>
  <ul>
  <li><a href="#abstract-syntax-trees" id="toc-abstract-syntax-trees" class="nav-link" data-scroll-target="#abstract-syntax-trees">Abstract syntax trees</a></li>
  <li><a href="#combining-tests" id="toc-combining-tests" class="nav-link" data-scroll-target="#combining-tests">Combining tests</a></li>
  <li><a href="#test-helpers" id="toc-test-helpers" class="nav-link" data-scroll-target="#test-helpers">Test helpers</a></li>
  <li><a href="#test-coverage" id="toc-test-coverage" class="nav-link" data-scroll-target="#test-coverage">Test coverage</a></li>
  <li><a href="#check-coverage-interactively" id="toc-check-coverage-interactively" class="nav-link" data-scroll-target="#check-coverage-interactively">Check coverage interactively</a></li>
  </ul></li>
  <li><a href="#macro-iteration" id="toc-macro-iteration" class="nav-link" data-scroll-target="#macro-iteration">Macro-iteration</a>
  <ul>
  <li><a href="#test-file-organization" id="toc-test-file-organization" class="nav-link" data-scroll-target="#test-file-organization">Test file organization</a>
  <ul>
  <li><a href="#rutils.r" id="toc-rutils.r" class="nav-link" data-scroll-target="#rutils.r"><code>R/utils.R</code></a></li>
  </ul></li>
  <li><a href="#test-package" id="toc-test-package" class="nav-link" data-scroll-target="#test-package">Test package</a></li>
  <li><a href="#check-coverage-on-buildinstall" id="toc-check-coverage-on-buildinstall" class="nav-link" data-scroll-target="#check-coverage-on-buildinstall">Check coverage on build/install</a>
  <ul>
  <li><a href="#other-metrics" id="toc-other-metrics" class="nav-link" data-scroll-target="#other-metrics">Other metrics</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#recap" id="toc-recap" class="nav-link" data-scroll-target="#recap">Recap</a></li>
  </ul>
</nav>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content">




<div class="cell">
<details open="">
<summary>packages</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(testthat)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lobstr)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(shiny)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(covr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>This post is the first in a series on testing shiny applications. I’ll cover developing and testing a set of utility functions for a shiny app-package using <a href="https://testthat.r-lib.org/"><code>testhat</code></a>. If you’d like to follow along, all the code I’ll be using is contained in the <a href="https://github.com/mjfrigaard/utap"><code>utap</code> R package on GitHub</a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># renv::install("mjfrigaard/utap")</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(utap)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="shiny-app-packages" class="level2">
<h2 class="anchored" data-anchor-id="shiny-app-packages">Shiny app-packages</h2>
<p>Testing the code in shiny app-packages can be more complicated than testing the code in a typical R package, because app-packages contain two types of code:</p>
<ol type="1">
<li><p><strong>Application code</strong>: functions designed to run the application (i.e., the <code>ui</code> and <code>server</code> functions, modules, standalone app functions will a call to <code>shinyApp()</code>, etc.)</p></li>
<li><p><strong>Everything else</strong>: functions or code used for connecting to databases, uploading, importing, or manipulating data, building visualizations and/or tables, generating custom HTML layouts, etc. The non-application code and functions in app-packages are typically referred to as ‘<a href="https://engineering-shiny.org/build-app-golem.html?#submodules-and-utility-functions">utility</a>’ or ‘<a href="https://mastering-shiny.org/scaling-functions.html#file-organisation">helper</a>’ functions</p></li>
</ol>
<p>These two types of code require different types of tests. Utility functions are usually accompanied by unit tests similar to the tests you’d find in a <a href="https://r-pkgs.org/testing-basics.html">standard R package</a>, while application code is tested using the <a href="https://shiny.posit.co/r/reference/shiny/1.7.0/testserver"><code>shiny::testServer()</code></a> function, or with the <a href="https://rstudio.github.io/shinytest2/"><code>shinytest2</code> package</a>.</p>
<p>This post will cover writing unit tests for a set of utility functions using <a href="https://testthat.r-lib.org/"><code>testthat</code></a> and <a href="https://covr.r-lib.org/"><code>covr</code></a>. Any tips or time-savers I’ve found will be in green callout boxes:</p>
<div class="callout callout-style-default callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="true" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
TIP!
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse show">
<div class="callout-body-container callout-body">
<div style="font-size: 1.10em; color: #696969;">
<p>This is a tip!</p>
</div>
</div>
</div>
</div>
</section>
<section id="what-are-unit-tests" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="what-are-unit-tests">What are unit tests?</h2>

<div class="no-row-height column-margin column-container"><div class="">
<p><img src="testthat.png" class="img-fluid" style="width:40.0%"></p>
</div></div><blockquote class="blockquote">
<p>“<em>A unit test is a piece of code that invokes a unit of work and checks one specific end result of that unit of work. If the assumptions on the end result turn out to be wrong, the unit test has failed. A unit test’s scope can span as little as a method or as much as multiple classes.</em>” - <a href="https://www.manning.com/books/the-art-of-unit-testing-second-edition">The Art of Unit Testing, 2nd edition</a></p>
</blockquote>
<p>I’ve found thinking of functions as ‘units of work’ and their desired behavior as an ‘end results’ provides a useful mental model during TDD. These terms also align nicely with the testing advice offered by <a href="https://r-pkgs.org/testing-design.html#sec-testing-design-principles"><code>testthat</code></a>:</p>
<blockquote class="blockquote">
<p><em>Strive to test each behaviour in one and only one test. Then if that behaviour later changes you only need to update a single test.</em></p>
</blockquote>
<p>In app-packages, the <code>testthat</code> package provides a comprehensive and flexible framework for performing unit tests.</p>
<section id="testthat" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="testthat">testthat</h3>
<p>Get started with <code>testthat</code> in your app-package by running <a href="https://usethis.r-lib.org/reference/use_testthat.html"><code>usethis::use_testthat()</code></a>. This function will create following files and folders:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>tests/</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  ├── testthat/</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  └── testthat.R</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>To create new tests, run <code>usethis::use_test("utils_fun")</code> (with <code>"utils_fun"</code> being the name of the function you’d like to test).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>usethis<span class="sc">::</span><span class="fu">use_test</span>(<span class="st">"utils_fun"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="sourceCode" id="cb5"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>✔ Setting active project to '/projects/apps/utap'</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>✔ Writing 'tests/testthat/test-utils_fun.R'</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>• Modify 'tests/testthat/test-utils_fun.R'</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="test-files" class="level4 page-columns page-full">
<h4 class="anchored" data-anchor-id="test-files">Test files</h4>
<p>New test files are be created and opened from the <code>tests/testthat/</code> folder (with a <code>test-</code> prefix).</p>
<ul>
<li><p>The initial contents of a new test file contains the boilerplate code below:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">"multiplication works"</span>, {</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(<span class="dv">2</span> <span class="sc">*</span> <span class="dv">2</span>, <span class="dv">4</span>)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></li>
</ul>

<div class="no-row-height column-margin column-container"><div class="">
<div id="fig-test-files" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="testthat-test-file.png" class="img-fluid figure-img" style="width:60.0%"></p>
<figcaption class="figure-caption">Figure&nbsp;1: testthat test file</figcaption>
</figure>
</div>
<p>Test files</p>
</div></div></section>
<section id="test-structure" class="level4 page-columns page-full">
<h4 class="anchored" data-anchor-id="test-structure">Test structure</h4>
<p><code>test_that()</code> sets the test “scope” or “execution environment”, and encapsulates the expectations.</p>
<ul>
<li><p>Note the use of curly brackets after the <code>code</code> argument:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="at">desc =</span> <span class="st">"description"</span>, <span class="at">code =</span> {</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></li>
</ul>

<div class="no-row-height column-margin column-container"><div class="">
<div id="fig-tests" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="testthat-tests.png" class="img-fluid figure-img" style="width:90.0%"></p>
<figcaption class="figure-caption">Figure&nbsp;2: tests</figcaption>
</figure>
</div>
<p><code>testthat</code> test</p>
</div></div></section>
<section id="expectations" class="level4 page-columns page-full">
<h4 class="anchored" data-anchor-id="expectations">Expectations</h4>
<p>Test expectations are the code that comes into direct contact with the <em>unit of work</em> and <em>end result</em> for each function. There are usually multiple expectations for any given function, so these are stored in <strong>tests</strong> (and the <code>desc</code> describes the test context for the set of expectations).</p>
<ul>
<li><p>All <code>testthat</code> expectations have an <code>expect_*</code> prefix:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="at">object =</span> <span class="dv">2</span> <span class="sc">*</span> <span class="dv">2</span>, <span class="at">expected =</span> <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></li>
</ul>

<div class="no-row-height column-margin column-container"><div class="">
<div id="fig-expectations" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="testthat-expectation.png" class="img-fluid figure-img" style="width:40.0%"></p>
<figcaption class="figure-caption">Figure&nbsp;3: expectations</figcaption>
</figure>
</div>
<p><code>testthat</code> expectation</p>
</div></div></section>
<section id="unit-test-development-workflow" class="level4">
<h4 class="anchored" data-anchor-id="unit-test-development-workflow">Unit test development workflow</h4>
<p>I develop unit tests using the following workflow:</p>
<ol type="1">
<li><p><strong>Create the test file and R script</strong>: I’ll start by creating these files with <code>usethis::use_r()</code> and <code>usethis::use_test()</code>, even if I know the names of these files will likely change as I develop (see more below).</p></li>
<li><p><strong>Define test context</strong>: I use the test context (entered as a character string in the first argument of <code>testthat::test_that()</code>) to capture each “unit of work” for each function. I like to keep the test context short and sweet–the “unit of work” followed by “works” will suffice in most circumstances, unless there’s a need for more specific details.</p></li>
<li><p><strong>Write expectations:</strong> These are the third item in the workflow, but conceptually these comes first–these are the “end results” I want from each function (i.e., compute a value, download a file, create a column, etc.).</p></li>
</ol>
<p>Tests and expectations are grouped into test files based on their related objectives or goals, and should correspond to a similar <code>.R</code> file in the <code>R/</code> folder.</p>
<p>While this workflow is probably not <em>technically</em> considered <a href="https://en.wikipedia.org/wiki/Test-driven_development">test-driven development</a>, I <em>do</em> set up the tests before I start writing any code in the <code>R/</code> folder. This comes in handy if you’re having to remind yourself where you stopped developing on a given project–I’ll just run <code>devtools::test()</code> and the first failing test reminds me where to look.</p>
<div class="callout callout-style-default callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
TIPS: Unit tests
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div style="font-size: 1.10em; color: #696969;">
<p>The advice on unit tests below (in <strong>bold</strong>) comes from <a href="https://www.manning.com/books/effective-software-testing">Effective Software Testing, 2022</a>. I’ve included descriptions of how <code>testthat</code> satisfies each recommendation:</p>
<ol type="1">
<li><p><strong>Unit tests should be fast</strong>: the text recommends unit tests take a ‘<em>couple of milliseconds</em>’ to execute. <code>testthat</code> tests typically fall within this threshold (and provide time measurements to identify bottlenecks).</p></li>
<li><p><strong>Unit tests are easy to control</strong>: i.e., ‘<em>input values and the expected result value are easy to adapt or modify in the test</em>.’ <code>testthat</code> expectations give us ample access to 1) the <code>expected</code> result and 2) the <code>observed</code> result.</p></li>
<li><p><strong>Unit tests are easy to write</strong>: i.e., ‘<em>do not require a complicated setup or additional work</em>’. When used combination with <code>usethis</code>, <code>testthat</code> unit tests can be set up, created, written, and run with a few lines of code:</p>
<ol type="1">
<li><code>usethis::use_testthat()</code><br>
</li>
<li><code>usethis::use_test()</code><br>
</li>
<li><code>&lt; write test &gt;</code><br>
</li>
<li><code>testthat::test_file()</code>, <code>testthat::test_dir()</code>, or <code>devtools::test()</code></li>
</ol></li>
</ol>
</div>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="app-utility-functions" class="level2">
<h2 class="anchored" data-anchor-id="app-utility-functions">App utility functions</h2>
<p>The utility functions I’ll be developing are designed to populate the <code>choices</code> argument for <code>shiny::selectInput()</code>. For example, the <code>pull_numeric_cols()</code> function would ‘pull’ the column names from an input <code>data.frame</code> or <code>tibble</code> (the example below uses <code>palmerpenguins::penguins</code>):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">pull_numeric_cols</span>(palmerpenguins<span class="sc">::</span>penguins)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<pre><code>##      bill_length_mm       bill_depth_mm   flipper_length_mm 
##    "bill_length_mm"     "bill_depth_mm" "flipper_length_mm" 
##         body_mass_g                year 
##       "body_mass_g"              "year"</code></pre>
</div>
<p>The return values would be passed to an <code>updateSelectInput()</code> in the <code>server</code> to provide column names by <code>type</code> (i.e., numeric, binary, or categorical). These functions can be used to quickly group variables into groups for data visualizations. For example, binary variables can be mapped the color aesthetic (if using <code>ggplot2</code>), and custom functions can be created for other graph layers (i.e., facets).</p>
<p>The <strong>unit of work</strong> for each hypothetical <code>pull_[type]_cols()</code> function would be, “<em>ingest a <code>data.frame</code> or <code>tibble</code> and identify columns by <code>type</code></em>,” and their <strong>end result</strong> might be “<em>return a (named) vector of column names by <code>type</code>.</em>” In this case, <code>[type]</code> refers to the variable type (i.e., numeric, categorical, binary, etc.). See the hypothetical UI output example below:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># UI code</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>shiny<span class="sc">::</span><span class="fu">selectInput</span>(</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">inputId =</span> <span class="fu">ns</span>(<span class="st">"x"</span>),</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">label =</span> <span class="st">"X variable:"</span>,</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">choices =</span> <span class="cn">NULL</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># server code</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>shiny<span class="sc">::</span><span class="fu">observe</span>({</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  num_vars <span class="ot">&lt;-</span> <span class="fu">pull_numeric_cols</span>(<span class="at">df =</span> <span class="fu">data</span>())</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  shiny<span class="sc">::</span><span class="fu">updateSelectInput</span>(session,</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">inputId =</span> <span class="st">"x"</span>,</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">choices =</span> num_vars,</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">selected =</span> num_vars[<span class="dv">1</span>])</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>  }) <span class="sc">|&gt;</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>  shiny<span class="sc">::</span><span class="fu">bindEvent</span>(<span class="fu">data</span>(),</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">ignoreNULL =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In the example above, <code>pull_numeric_cols()</code> is passed a reactive dataset (<code>data()</code>), and the output is used to update the <code>selectInput()</code>.</p>
<div class="cell">
<div class="cell-output-display no-overflow-x">
<div class="form-group shiny-input-container">
<label class="control-label" id="num_cols-label" for="num_cols">X variable:</label>
<div>
<select id="num_cols"><option value="bill_length_mm" selected="">bill_length_mm</option>
<option value="bill_depth_mm">bill_depth_mm</option>
<option value="flipper_length_mm">flipper_length_mm</option>
<option value="body_mass_g">body_mass_g</option>
<option value="year">year</option></select>
<script type="application/json" data-for="num_cols" data-nonempty="">{"plugins":["selectize-plugin-a11y"]}</script>
</div>
</div>
</div>
</div>
<p><br></p>
</section>
<section id="micro-iteration" class="level2">
<h2 class="anchored" data-anchor-id="micro-iteration">Micro-iteration</h2>
<p>In <a href="https://r-pkgs.org/testing-basics.html#run-tests">R packages</a>, micro-iteration is defined as, “<em>the interactive phase where you initiate and refine a function and its tests in tandem.</em>” If you’re using <a href="https://en.wikipedia.org/wiki/Test-driven_development?oldformat=true">TDD</a>, you’ll write the test first, then write the function to pass the test.</p>
<p>The first unit test I’ll create is for <code>select_column_class()</code>, a function designed to return columns according to their <code>class()</code>.</p>
<section id="function-names" class="level4">
<h4 class="anchored" data-anchor-id="function-names">Function names</h4>
<p>Coming up with names for functions can be challenging. I like to follow the <a href="https://style.tidyverse.org/syntax.html#object-names"><code>tidyverse</code> style guide</a> and use short verbs as a prefix (<code>make_</code>, <code>get_</code>, <code>check_</code> etc.). I also like to use names that give ‘future’ me hints as to their behavior (i.e., <code>select_column_class()</code> imports and has similar behavior to <code>dplyr::select()</code>, while <code>pull_[type]_cols()</code> is more like <code>dplyr::pull()</code>)</p>
</section>
<section id="create-test-file" class="level3">
<h3 class="anchored" data-anchor-id="create-test-file">Create test file</h3>
<p>I create the test file and function file in the <strong>Console</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>usethis<span class="sc">::</span><span class="fu">use_test</span>(<span class="st">"select_column_class"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="sourceCode" id="cb14"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>✔ Setting active project to '/projects/apps/utap'</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>✔ Writing 'tests/testthat/test-select_column_class.R'</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>• Modify 'tests/testthat/test-select_column_class.R'</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>usethis<span class="sc">::</span><span class="fu">use_r</span>(<span class="st">"select_column_class"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="sourceCode" id="cb16"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>• Modify 'R/select_column_class.R'</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="test-context" class="level3">
<h3 class="anchored" data-anchor-id="test-context">Test context</h3>
<p>The test context (entered as a character string in the first argument of <code>testthat::test_that()</code>) includes the “unit of work” for the function, followed by “works”:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="at">desc =</span> <span class="st">"select_column_class() is.tibble/is.data.frame works"</span>, {</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Before I can start developing the <code>select_column_class()</code> function and it’s tests, I’ll need data. R comes with example data objects in the <code>datasets</code> package, but it’s nice to have control over the data being used in your unit tests. I’ll cover how to add test data available in your app-package.</p>
</section>
<section id="test-data" class="level3">
<h3 class="anchored" data-anchor-id="test-data">Test data</h3>
<p>Creating test data is covered in <a href="https://r-pkgs.org/testing-design.html#storing-test-data">R packages</a>, but I’ll summarize the key points:</p>
<ol type="1">
<li>Test data (and other objects) can either be created within a test, or as a persistent <a href="https://r-pkgs.org/testing-advanced.html#sec-testing-advanced-concrete-fixture">test fixture</a><br>
</li>
<li>Test data fixtures should be stored in <code>tests/testthat/fixtures/&lt;test_data.rds&gt;</code></li>
<li>The code used to create any test data fixtures should be stored in the same folder with a <code>make_</code> prefix (i.e., <code>tests/testthat/fixtures/&lt;make_test_data.R&gt;</code>)</li>
</ol>
<p>This is easier to picture with a demonstration: In the <code>tests/testthat/</code> folder, I’ll create a new <code>fixtures</code> folder, and add a <code>make_testdata_col_class.R</code> file.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>tests/testthat/</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>        └── fixtures/</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>                └── make_testdata_col_class.R</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>In <code>make_testdata_col_class.R</code>, I’ll create <code>testdata_col_class</code> using the code below:</p>
<div class="cell">
<details>
<summary>test_data for test-select_column_class.R</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>testdata_col_class <span class="ot">&lt;-</span> tibble<span class="sc">::</span><span class="fu">tibble</span>(</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a> <span class="at">log_var =</span> <span class="fu">c</span>(<span class="cn">TRUE</span>, <span class="cn">FALSE</span>, <span class="cn">TRUE</span>),</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a> <span class="at">int_var =</span> <span class="fu">c</span>(1L, 2L, 3L),</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a> <span class="at">dbl_var =</span> <span class="fu">c</span>(<span class="fl">1.1</span>, <span class="fl">2.2</span>, <span class="fl">3.3</span>),</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a> <span class="at">chr_var =</span> <span class="fu">c</span>(<span class="st">"item:1"</span>, <span class="st">"item:2"</span>, <span class="st">"item:3"</span>),</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a> <span class="at">fct_var =</span> <span class="fu">factor</span>(</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>   <span class="fu">c</span>(<span class="st">"group 1"</span>, <span class="st">"group 2"</span>, <span class="st">"group 3"</span>),</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>   <span class="at">levels =</span> <span class="fu">c</span>(</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>     <span class="st">"group 1"</span>, <span class="st">"group 2"</span>, <span class="st">"group 3"</span>)),</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a> <span class="at">ord_var =</span> <span class="fu">factor</span>(</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>   <span class="fu">c</span>(<span class="st">"level 1"</span>, <span class="st">"level 2"</span>, <span class="st">"level 3"</span>),</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>   <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"level 1"</span>, <span class="st">"level 2"</span>, <span class="st">"level 3"</span>),</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>   <span class="at">ordered =</span> <span class="cn">TRUE</span>),</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a> <span class="at">list_var =</span> <span class="fu">list</span>(</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>   <span class="at">log_vec =</span> <span class="fu">c</span>(<span class="cn">TRUE</span>, <span class="cn">FALSE</span>),</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>   <span class="at">dbl_vec =</span> <span class="fu">c</span>(<span class="fl">1.1</span>, <span class="fl">2.2</span>),</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>   <span class="at">chr_var =</span> <span class="fu">c</span>(<span class="st">"item:1"</span>, <span class="st">"item:2"</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>testdata_col_class</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="do">## # A tibble: 3 × 7</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="do">##   log_var int_var dbl_var chr_var fct_var ord_var list_var  </span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="do">##   &lt;lgl&gt;     &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;   &lt;fct&gt;   &lt;ord&gt;   &lt;named li&gt;</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="do">## 1 TRUE          1     1.1 item:1  group 1 level 1 &lt;lgl [2]&gt; </span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="do">## 2 FALSE         2     2.2 item:2  group 2 level 2 &lt;dbl [2]&gt; </span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="do">## 3 TRUE          3     3.3 item:3  group 3 level 3 &lt;chr [2]&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>I’ll save <code>testdata_col_class</code> in <code>tests/testthat/fixtures/</code> as <code>testdata_col_class.rds</code>:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>tests/testthat/</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>        └── fixtures/</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>                ├── make_testdata_col_class.R</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>                └── testdata_col_class.rds</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>To load the data into my test, I’ll add the following to the top of the test context:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">test_that</span>(<span class="at">desc =</span> <span class="st">"select_column_class() is.tibble/is.data.frame works"</span>, {</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  testdata_col_class <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">test_path</span>(<span class="st">"fixtures"</span>, <span class="st">"testdata_col_class.rds"</span>))</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>testthat::test_path()</code> will load the data from the testing directory when I’m ready to run my test.</p>
</section>
<section id="expectations-1" class="level3">
<h3 class="anchored" data-anchor-id="expectations-1">Expectations</h3>
<p>In <code>expect_equal()</code>, I’ll verify the structure of the returned <code>object</code> is a <code>data.frame</code>/<code>tibble</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">"select_column_class() is.tibble/is.data.frame works"</span>, {</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  testdata_col_class <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">test_path</span>(<span class="st">"fixtures"</span>, <span class="st">"testdata_col_class.rds"</span>))</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># check tibble</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">object =</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select_column_class</span>(</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">df =</span> testdata_col_class,</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">class =</span> <span class="st">"???"</span>) <span class="sc">|&gt;</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>          tibble<span class="sc">::</span><span class="fu">is_tibble</span>(),</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">expected =</span> <span class="cn">TRUE</span>)</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Writing my expectations first forces me to make some decisions about what the arguments will be for the <code>select_column_class()</code> function (i.e., <code>df</code> and <code>class</code>).</p>
<p><code>select_column_class()</code> should return the columns according to their <code>class</code>, so I’ll tests to verify the class of the return columns.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># check logical</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">object =</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select_column_class</span>(</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">df =</span> testdata_col_class,</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">class =</span> <span class="st">"log"</span>) <span class="sc">|&gt;</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>          <span class="fu">lapply</span>(is.logical) <span class="sc">|&gt;</span> <span class="fu">unlist</span>() <span class="sc">|&gt;</span> <span class="fu">unique</span>(),</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">expected =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>I try to write these in a way that’s flexible (should the test data change in the future).</p>
<div class="callout callout-style-default callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<strong>Expectation-Driven Development</strong>
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Whether or not you decide to adopt Test-Driven Development, I strongly recommend writing test expectations while you’re developing functions. It’s a great opportunity to clarify a function’s intended behaviors, arguments, and error/warning messages.</p>
</div>
</div>
</div>
<p>After including tests for each class, I’ll include a test for the error message from <code>select_column_class()</code> with <code>testthat::expect_error()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># test error type</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">"select_column_class() type error"</span>, {</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  testdata_col_class <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">test_path</span>(<span class="st">"fixtures"</span>, <span class="st">"testdata_col_class.rds"</span>))</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># test type error</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_error</span>(</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">object =</span> <span class="fu">select_column_class</span>(</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">df =</span> testdata_col_class, </span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">class =</span> <span class="st">"array"</span>)</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>When I’ve covered my intended ‘end results’ for <code>select_column_class()</code> (i.e., when it works and what happens when it doesn’t), I’ll write the function:</p>
<div class="cell">
<details>
<summary>select_column_class()</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>select_column_class <span class="ot">&lt;-</span> <span class="cf">function</span>(df, class) {</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  col_class <span class="ot">&lt;-</span> <span class="cf">function</span>(df, class) {</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span>(class,</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">log =</span> dplyr<span class="sc">::</span><span class="fu">select</span>(tibble<span class="sc">::</span><span class="fu">as_tibble</span>(df), dplyr<span class="sc">::</span><span class="fu">where</span>(is.logical)),</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">int =</span> dplyr<span class="sc">::</span><span class="fu">select</span>(tibble<span class="sc">::</span><span class="fu">as_tibble</span>(df), dplyr<span class="sc">::</span><span class="fu">where</span>(is.integer)),</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">dbl =</span> dplyr<span class="sc">::</span><span class="fu">select</span>(tibble<span class="sc">::</span><span class="fu">as_tibble</span>(df), dplyr<span class="sc">::</span><span class="fu">where</span>(is.double)),</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">chr =</span> dplyr<span class="sc">::</span><span class="fu">select</span>(tibble<span class="sc">::</span><span class="fu">as_tibble</span>(df), dplyr<span class="sc">::</span><span class="fu">where</span>(is.character)),</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">fct =</span> dplyr<span class="sc">::</span><span class="fu">select</span>(tibble<span class="sc">::</span><span class="fu">as_tibble</span>(df), dplyr<span class="sc">::</span><span class="fu">where</span>(is.factor)),</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">ord =</span> dplyr<span class="sc">::</span><span class="fu">select</span>(tibble<span class="sc">::</span><span class="fu">as_tibble</span>(df), dplyr<span class="sc">::</span><span class="fu">where</span>(is.ordered)),</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">list =</span> dplyr<span class="sc">::</span><span class="fu">select</span>(tibble<span class="sc">::</span><span class="fu">as_tibble</span>(df), dplyr<span class="sc">::</span><span class="fu">where</span>(is.list))</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>  cl <span class="ot">&lt;-</span> <span class="fu">unique</span>(class)</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>  cl_check <span class="ot">&lt;-</span> cl <span class="sc">%nin%</span> <span class="fu">c</span>(<span class="st">"log"</span>, <span class="st">"int"</span>, <span class="st">"dbl"</span>, <span class="st">"chr"</span>, <span class="st">"fct"</span>, <span class="st">"ord"</span>, <span class="st">"list"</span>)</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">any</span>(cl_check)) {</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>    cli<span class="sc">::</span><span class="fu">cli_abort</span>(<span class="st">"Invalid `class` argument. Must be one of:</span><span class="sc">\n</span></span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a><span class="st">          'log', 'int', 'dbl', 'chr', 'fct', 'ord', 'list'"</span>)</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>  col_list <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map</span>(<span class="at">.x =</span> class, <span class="at">.f =</span> col_class, <span class="at">df =</span> df)</span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>  df_cols <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">list_cbind</span>(col_list, <span class="at">size =</span> <span class="fu">nrow</span>(df))</span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">ncol</span>(df_cols) <span class="sc">&lt;</span> <span class="dv">1</span> <span class="sc">||</span> <span class="fu">nrow</span>(df_cols) <span class="sc">&lt;</span> <span class="dv">1</span>) {</span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a>    df_cols <span class="ot">&lt;-</span> <span class="fu">structure</span>(<span class="fu">list</span>(),</span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a>      <span class="at">class =</span> <span class="fu">c</span>(<span class="st">"tbl_df"</span>, <span class="st">"tbl"</span>, <span class="st">"data.frame"</span>),</span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a>      <span class="at">row.names =</span> <span class="fu">integer</span>(<span class="dv">0</span>),</span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a>      <span class="at">names =</span> <span class="fu">character</span>(<span class="dv">0</span>)</span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(df_cols)</span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb26-34"><a href="#cb26-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(df_cols)</span>
<span id="cb26-35"><a href="#cb26-35" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb26-36"><a href="#cb26-36" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="recap-test-data" class="level4">
<h4 class="anchored" data-anchor-id="recap-test-data">Recap: test data</h4>
<p>Below is a summary of tips for adding data your tests.</p>
<div id="fig-unit_test_dep_data" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<div id="fig-unit_test_dep_data" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="unit_test_dep_data.png" class="img-fluid figure-img" style="width:100.0%" data-ref-parent="fig-unit_test_dep_data"></p>
<figcaption class="figure-caption">(a) Unit test fixtures</figcaption>
</figure>
</div>
<figcaption class="figure-caption">Figure&nbsp;4: Unit test fixtures</figcaption>
</figure>
</div>
</section>
</section>
</section>
<section id="mezzo-iteration" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="mezzo-iteration">Mezzo-iteration</h2>
<p>The <code>select_column_class()</code> will return a <code>tibble()</code> with the columns matching the <code>class</code> argument, but I’ll also need an argument that allows me to adjust the returned object to a named character vector.</p>
<p>That’s the job of <code>get_column_class()</code>–this is a wrapper around <code>select_column_class()</code> with an additional <code>return_tbl</code> argument that, if <code>FALSE</code>, returns the column names as a named vector.</p>
<section id="abstract-syntax-trees" class="level4">
<h4 class="anchored" data-anchor-id="abstract-syntax-trees">Abstract syntax trees</h4>
<p>While developing R functions, I’ve found the <code>ast()</code> function from the <a href="https://lobstr.r-lib.org/reference/ast.html"><code>lobstr</code> package</a> can be great for keeping track of nested function calls.</p>
<p>For example, <code>select_column_class()</code> has a nested <code>col_class()</code> function that isn’t tested directly. So how do I make sure I’m keeping track of these nested functions in case they throw an error? I’ll build an abstract function tree for the function in the <a href="https://github.com/mjfrigaard/utap/blob/main/vignettes/utap.Rmd">documentation</a>.</p>
<p>Below is the abstract syntax tree for <code>select_column_class()</code>:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>█─select_column_class 
└─█─col_class </code></pre>
</div>
</div>
<p>The tree above is simple–it only has two functions so far–but as packages grow these abstract displays become more important for tracking function calls (and tests!).</p>
</section>
<section id="combining-tests" class="level3">
<h3 class="anchored" data-anchor-id="combining-tests">Combining tests</h3>
<p><code>get_column_class()</code> calls <code>select_column_class()</code>, so I’ll place both unit tests in the <code>tests/testthat/test-column_classes.R</code> file, and create the corresponding <a href="https://github.com/mjfrigaard/utap/blob/main/R/column_classes.R"><code>R/column_classes.R</code> file</a></p>
<p>To capture these nested functions visually, I’ll include a function tree in a vignette or other source documentation.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>█─get_column_class 
└─█─select_column_class 
  └─█─col_class </code></pre>
</div>
</div>
<p>I’ve combined <code>select_column_class()</code> and <code>get_column_class()</code> into a single file because I know every <code>pull_[type]_cols()</code> function would use <code>get_column_class()</code>. The following function tree captures this relationship.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>█─get_column_class 
├─█─select_column_class 
│ └─█─col_class 
├─█─pull_binary_cols 
├─█─pull_facet_cols 
├─█─pull_cat_cols 
└─█─pull_numeric_cols </code></pre>
</div>
</div>
<div class="callout callout-style-default callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-4-contents" aria-controls="callout-4" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<strong>Function file names</strong>
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-4" class="callout-4-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>In shiny app-packages, it’s common to combine related functions (i.e., function families) into a single <code>.R</code> file with a prefix.</p>
<p>For example, a standalone app function combines the code that would otherwise sit in <code>ui.R</code> and <code>server.R</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>myApp <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  shiny<span class="sc">::</span><span class="fu">shinyApp</span>(<span class="at">ui =</span> </span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>      shiny<span class="sc">::</span><span class="fu">tagList</span>(</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>        <span class="co"># code from ui.R</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">server =</span> <span class="co"># code from server.R</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Other files that are automatically run with a standard shiny app (i.e., <code>global.R</code> or <code>helpers.R</code> files that used to load data, set themes/colors, etc.,) can be converted into functions and/or package files based on their purpose. For more information on organizing your <code>R/</code> folder, read <a href="https://r-pkgs.org/code.html#sec-code-organising">this section in R Packages</a>.</p>
<p>Also check out <code>golem::add_utils()</code> and <code>golem::add_fct()</code> for creating function files specific to shiny modules.</p>
</div>
</div>
</div>
<p>In the <code>test-column_classes.R</code> test file, I’ll need more data for testing, but rather than create test data files for each test, I’ll use test helpers to create the test data.</p>
</section>
<section id="test-helpers" class="level3">
<h3 class="anchored" data-anchor-id="test-helpers">Test helpers</h3>
<p>Test helpers are stored in <code>tests/testthat/helper.R</code> and usually contain functions or code that 1) is too long to repeat with each test, and 2) doesn’t take too much time or memory to run. Read more about test helpers <a href="https://r-pkgs.org/testing-advanced.html#sec-testing-advanced-fixture-helper">here.</a></p>
<p>I’ve created a <a href="https://github.com/mjfrigaard/utap/blob/main/tests/testthat/helper.R">set of test helpers</a> in <code>utap</code> for creating different kinds of test data (because I’ll be repeatedly defining columns with slightly different attributes).</p>
<p>For example, <code>col_maker()</code> can be used to create a <code>tibble</code> with columns based on the <code>col_type</code>, <code>size</code>, and <code>missing</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">col_maker</span>(<span class="at">col_type =</span> <span class="fu">c</span>(<span class="st">"log"</span>, <span class="st">"int"</span>, <span class="st">"dbl"</span>, </span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>                       <span class="st">"chr"</span>, <span class="st">"fct"</span>, <span class="st">"ord"</span>),</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>          <span class="at">size =</span> <span class="dv">6</span>,</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>          <span class="at">missing =</span> <span class="cn">TRUE</span>)</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="do">## # A tibble: 6 × 6</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="do">##   log_var int_var dbl_var chr_var fct_var ord_var</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="do">##   &lt;lgl&gt;     &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;   &lt;fct&gt;   &lt;ord&gt;  </span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="do">## 1 TRUE          1     0.1 item:1  group 1 level 1</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="do">## 2 FALSE       135     3   item:2  group 2 level 2</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a><span class="do">## 3 NA          269    NA   item:3  group 3 level 3</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a><span class="do">## 4 TRUE        403     0.1 &lt;NA&gt;    &lt;NA&gt;    &lt;NA&gt;   </span></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a><span class="do">## 5 FALSE        NA     3   item:1  group 1 level 1</span></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a><span class="do">## 6 NA            1    NA   item:1  group 2 level 2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>I can also create tibbles with custom columns using individual helper <code>_maker()</code> functions:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>tibble<span class="sc">::</span><span class="fu">tibble</span>(</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">log_var =</span> <span class="fu">log_maker</span>(<span class="at">size =</span> <span class="dv">2</span>),</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">int_var =</span> <span class="fu">int_maker</span>(<span class="at">size =</span> <span class="dv">2</span>),</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">dbl_var =</span> <span class="fu">dbl_maker</span>(<span class="at">size =</span> <span class="dv">2</span>),</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">chr_var =</span> <span class="fu">chr_maker</span>(<span class="at">size =</span> <span class="dv">2</span>),</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">list_var =</span> <span class="fu">list</span>(<span class="at">fct_var =</span> <span class="fu">fct_maker</span>(<span class="at">size =</span> <span class="dv">3</span>), </span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>                    <span class="at">ord_var =</span> <span class="fu">ord_maker</span>(<span class="at">size =</span> <span class="dv">3</span>)),</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a><span class="do">## # A tibble: 2 × 5</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a><span class="do">##   log_var int_var dbl_var chr_var list_var    </span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a><span class="do">##   &lt;lgl&gt;     &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;   &lt;named list&gt;</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a><span class="do">## 1 TRUE          1     0.1 item: 1 &lt;fct [3]&gt;   </span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a><span class="do">## 2 FALSE         7     1   item: 2 &lt;ord [3]&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>These helpers make it easier to iterate through the test expectations <em>and</em> function development, because <code>tibble</code>s like the one above can be developed <em>inside</em> each test.</p>
<ul>
<li><p>Below is an example for testing if <code>get_column_class()</code> will correctly identify the <code>logical</code> columns (for both return objects):</p>
<div class="cell">
<details>
<summary>using test helpers</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">"get_column_class() logical"</span>, {</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># test logical class</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">object =</span> <span class="fu">get_column_class</span>(</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>      <span class="co"># use test helper</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">df =</span> <span class="fu">col_maker</span>(</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">col_type =</span> <span class="fu">c</span>(<span class="st">"log"</span>, <span class="st">"int"</span>, <span class="st">"dbl"</span>, <span class="st">"chr"</span>),</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>          <span class="at">size =</span> <span class="dv">6</span>,</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>          <span class="at">missing =</span> <span class="cn">FALSE</span>,</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>          <span class="at">lvls =</span> <span class="dv">4</span>),</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">class =</span> <span class="st">"log"</span>) <span class="sc">|&gt;</span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>      <span class="fu">unlist</span>() <span class="sc">|&gt;</span></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">is.logical</span>(),</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">expected =</span> <span class="cn">TRUE</span></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># test logical names</span></span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(</span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">object =</span> <span class="fu">get_column_class</span>(</span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>      <span class="co"># use test helper</span></span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">df =</span> <span class="fu">col_maker</span>(</span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a>        <span class="at">col_type =</span> <span class="fu">c</span>(<span class="st">"log"</span>, <span class="st">"int"</span>, <span class="st">"dbl"</span>, <span class="st">"chr"</span>),</span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>          <span class="at">size =</span> <span class="dv">6</span>,</span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a>          <span class="at">missing =</span> <span class="cn">FALSE</span>,</span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a>          <span class="at">lvls =</span> <span class="dv">4</span>),</span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a>     <span class="at">class =</span> <span class="st">"log"</span>,</span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a>      <span class="at">return_tbl =</span> <span class="cn">FALSE</span></span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">expected =</span> <span class="fu">c</span>(<span class="at">log_var =</span> <span class="st">"log_var"</span>)</span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb33-30"><a href="#cb33-30" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div></li>
</ul>
<p>When I’m confident with the <code>get_column_class()</code> function and it’s tests, I’ll save the test file and run <code>testthat::test_file()</code>.</p>
<div class="cell">
<details>
<summary>show/hide get_column_class()</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>get_column_class <span class="ot">&lt;-</span> <span class="cf">function</span>(df, class, <span class="at">return_tbl =</span> <span class="cn">TRUE</span>) {</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">isFALSE</span>(return_tbl)) {</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>    col_types_df <span class="ot">&lt;-</span> <span class="fu">select_column_class</span>(df, <span class="at">class =</span> class)</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>    nms <span class="ot">&lt;-</span> <span class="fu">names</span>(col_types_df)</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>    col_types <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">set_names</span>(nms)</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>    col_types <span class="ot">&lt;-</span> <span class="fu">select_column_class</span>(df, <span class="at">class =</span> class)</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(col_types)</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_file</span>(<span class="st">"tests/testthat/test-column_classes.R"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="sourceCode" id="cb36"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>[ FAIL 0 | WARN 0 | SKIP 0 | PASS 23 ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="test-coverage" class="level3">
<h3 class="anchored" data-anchor-id="test-coverage">Test coverage</h3>
<p><em>How many tests should I write?</em></p>
<p>As function behavior grows in complexity, so does the number of expectations. In <code>testthat</code>, expectations are captured in tests, and code coverage measures the extent to which the tests in the <code>tests/testthat/</code> folder cover the possible execution paths of the functions in the <code>R/</code> folder (i.e.&nbsp;the package codebase).</p>
<p>Code test coverage is a way to confirm that the unit tests are robust enough to verify that your code behaves as expected. In R packages, code coverage is discussed in the <a href="https://r-pkgs.org/testing-design.html#sec-testing-design-coverage">testing chapter</a> using the <a href="https://covr.r-lib.org/"><code>covr</code> package</a>.</p>
</section>
<section id="check-coverage-interactively" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="check-coverage-interactively">Check coverage interactively</h3>
<p>During development, check the code coverage of a test file with <code>devtools::test_coverage_active_file()</code>, or, if this function is being temperamental, use the combination of functions below from <code>covr</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>covr<span class="sc">::</span><span class="fu">file_coverage</span>(</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">source_files =</span> <span class="st">"R/column_classes.R"</span>, </span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">test_files =</span> <span class="st">"tests/testthat/test-column_classes.R"</span>) <span class="sc">|&gt;</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>  covr<span class="sc">::</span><span class="fu">report</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Below is the output in the <strong>Viewer</strong> when <code>devtools::test_coverage_active_file()</code> is entered in the <strong>Console</strong>:</p>
<div class="column-body-outset-right">
<div id="fig-column_classes_covr" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<div id="fig-column_classes_covr" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="column_classes_covr.png" class="img-fluid figure-img" style="width:100.0%" data-ref-parent="fig-column_classes_covr"></p>
<figcaption class="figure-caption">(a) Test coverage using <code>devtools::test_coverage_active_file()</code></figcaption>
</figure>
</div>
<figcaption class="figure-caption">Figure&nbsp;5: Unit test coverage interactively</figcaption>
</figure>
</div>
</div>
<p>I can see from the output I don’t have test coverage for the <code>select_column_class()</code> behavior when the <code>class</code> argument doesn’t return any columns from <code>df</code>. The function is designed to return an empty <code>tibble</code> if this occurs:</p>
<div id="fig-column_classes_covr_incomplete" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<div id="fig-column_classes_covr_incomplete" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="column_classes_covr_incomplete.png" class="img-fluid figure-img" style="width:100.0%" data-ref-parent="fig-column_classes_covr_incomplete"></p>
<figcaption class="figure-caption">(a) Behavior not tested in <code>select_column_class()</code></figcaption>
</figure>
</div>
<figcaption class="figure-caption">Figure&nbsp;6: The area in red is the untested portion of <code>select_column_class()</code></figcaption>
</figure>
</div>
<p>To test this behavior, I’ll write two expectations:</p>
<ul>
<li><p>The first expectation (<code>expect_s3_class()</code>) checks the class of the return object from <code>select_column_class()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># test class of empty tibble</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_s3_class</span>(</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">object =</span> <span class="fu">select_column_class</span>(</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>      <span class="at">df =</span> <span class="fu">col_maker</span>(<span class="at">col_type =</span> <span class="fu">c</span>(<span class="st">"int"</span>, <span class="st">"dbl"</span>),</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">size =</span> <span class="dv">6</span>, </span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">missing =</span> <span class="cn">FALSE</span>),</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">class =</span> <span class="st">"log"</span>),</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">class =</span> <span class="fu">c</span>(<span class="st">"tbl_df"</span>, <span class="st">"tbl"</span>, <span class="st">"data.frame"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></li>
<li><p>The second expectation verifies there are zero columns in this return tibble:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># test rows of empty tibble</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">object =</span> <span class="fu">ncol</span>(<span class="fu">select_column_class</span>(</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>      <span class="at">df =</span> <span class="fu">col_maker</span>(<span class="at">col_type =</span> <span class="fu">c</span>(<span class="st">"int"</span>, <span class="st">"dbl"</span>),</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">size =</span> <span class="dv">6</span>, </span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">missing =</span> <span class="cn">FALSE</span>),</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">class =</span> <span class="st">"log"</span>)),</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">expected =</span> 0L)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></li>
</ul>
<p>After adding these tests to the <code>test-column_classes.R</code> test file, I’ll run <code>testthat::test_file()</code> and <code>devtools::test_coverage_active_file()</code> again:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_file</span>(<span class="st">"tests/testthat/test-column_classes.R"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="sourceCode" id="cb41"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>[ FAIL 0 | WARN 0 | SKIP 0 | PASS 25 ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>devtools<span class="sc">::</span><span class="fu">test_coverage_active_file</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="column-body-outset-right">
<div id="fig-column_classes_covr_complete" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<div id="fig-column_classes_covr_complete" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="column_classes_covr_complete.png" class="img-fluid figure-img" style="width:100.0%" data-ref-parent="fig-column_classes_covr_complete"></p>
<figcaption class="figure-caption">(a) Test coverage using <code>devtools::test_coverage_active_file()</code></figcaption>
</figure>
</div>
<figcaption class="figure-caption">Figure&nbsp;7: Complete code coverage for <code>column_classes.R</code></figcaption>
</figure>
</div>
</div>
<p>100% is great, but uncommon. Striving for a high percentage of coverage is a good practice, it doesn’t guarantee that the function always behaves as expected. Unit tests might execute a line of code, but still not catch a bug due to the design of the test (it’s easy to have high coverage if the unit tests are shallow and don’t check for any potential <a href="https://en.wikipedia.org/wiki/Edge_case">edge cases</a>).</p>
<p>I’ll address code coverage again in the next section, but checking coverage regularly will help ensure function behaviors don’t go overlooked.</p>
</section>
</section>
<section id="macro-iteration" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="macro-iteration">Macro-iteration</h2>
<p>After developing the functions in <code>utap</code>, the files in the <code>R/</code> folder are organized into names <a href="https://r-pkgs.org/code.html#sec-code-organising">based on the</a> ‘<em>main function and its supporting helpers</em>’:</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>R/</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>├── column_classes.R</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>├── pull_binary_cols.R</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>├── pull_cat_cols.R</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>├── pull_facet_cols.R</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>├── pull_numeric_cols.R</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>└── utils.R</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="test-file-organization" class="level3">
<h3 class="anchored" data-anchor-id="test-file-organization">Test file organization</h3>
<p>The <code>tests/testthat/</code> folder file names have identical names as the files in the <code>R/</code> folder.</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>tests/testthat/</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>        ├── test-column_classes.R</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>        ├── test-pull_binary_cols.R</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>        ├── test-pull_cat_cols.R</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>        ├── test-pull_facet_cols.R</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>        ├── test-pull_numeric_cols.R</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>        └── test-utils.R</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="rutils.r" class="level4">
<h4 class="anchored" data-anchor-id="rutils.r"><code>R/utils.R</code></h4>
<p>It’s common for R packages to have a general <code>R/utils.R</code> file that defines the ‘utility’ functions. This practice isn’t discouraged in R Packages, but these files can become a catch-all for any functions that don’t have a clear home (read more <a href="https://rud.is/b/2018/04/08/dissecting-r-package-utility-belts/">here</a>).</p>
<p>I’ve only stored the <code>%nin%</code> operator in <code>R/utils.R</code>, and it’s test is shown below:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">"%nin% works"</span>, {</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_false</span>(</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">object =</span> <span class="st">"A"</span> <span class="sc">%nin%</span> LETTERS)</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_false</span>(</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">object =</span> <span class="dv">1</span> <span class="sc">%nin%</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>)</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_true</span>(</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">object =</span> <span class="dv">1</span> <span class="sc">%nin%</span> <span class="dv">2</span><span class="sc">:</span><span class="dv">10</span>)</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="test-package" class="level3">
<h3 class="anchored" data-anchor-id="test-package">Test package</h3>
<p>When I’ve completed a set of test files, I can use <code>devtools::test()</code> to check if they’re passing.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>devtools<span class="sc">::</span><span class="fu">test</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="sourceCode" id="cb47"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>ℹ Testing utap</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>✔ | F W S  OK | Context</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>✔ |        25 | column_classes                                                     </span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>✔ |        29 | pull_binary_cols                                                   </span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>✔ |         4 | pull_cat_cols                                                      </span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>✔ |        20 | pull_facet_cols                                                    </span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>✔ |         5 | pull_numeric_cols                                                  </span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>✔ |         3 | utils                                                              </span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>══ Results ═════════════════════════════════════════════════════════════════════</span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>Duration: 2.1 s</span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>[ FAIL 0 | WARN 0 | SKIP 0 | PASS 86 ]</span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a>🎯 Your tests hit the mark 🎯</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The output above shows all tests are passing (and some helpful words of encouragement). As you can see, the number of tests correspond to the number of functions in each test file.</p>
<p>For example, <code>pull_binary_cols()</code> and <code>pull_facet_cols()</code> required additional internal functions to define their use:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>█─pull_binary_cols 
├─█─check_binary_vec 
│ ├─█─check_log_binary 
│ ├─█─check_int_binary 
│ └─█─check_fct_binary 
└─█─make_binary_vec </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>█─pull_facet_cols 
├─█─check_facet_vec 
│ ├─█─check_chr_facet 
│ └─█─check_fct_facet 
└─█─make_facet_vec </code></pre>
</div>
</div>
<p>Wheras <code>pull_cat_cols()</code> and <code>pull_numeric_cols()</code> map onto existing classes:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>█─pull_cat_cols 
├─█─is.factor 
└─█─is.character </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>█─pull_numeric_cols 
├─█─is.integer 
└─█─is.double </code></pre>
</div>
</div>
</section>
<section id="check-coverage-on-buildinstall" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="check-coverage-on-buildinstall">Check coverage on build/install</h3>
<p>To check the code coverage for the utap package, I can run <code>devtools::test_coverage()</code> to view the output in the <strong>Viewer</strong>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>devtools<span class="sc">::</span><span class="fu">test_coverage</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="sourceCode" id="cb53"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>ℹ Computing test coverage for utap</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="column-body-outset-right">
<div id="fig-utap_coverage" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<div id="fig-utap_coverage" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="utap_coverage.png" class="img-fluid figure-img" style="width:100.0%" data-ref-parent="fig-utap_coverage"></p>
<figcaption class="figure-caption">(a) Final test coverage for <code>utap</code> package</figcaption>
</figure>
</div>
<figcaption class="figure-caption">Figure&nbsp;8: <code>devtools::test_coverage()</code></figcaption>
</figure>
</div>
</div>
<p>Clicking on any of the <strong>Files</strong> will open the <strong>Source</strong> tab and give a summary like the one above from <code>devtools::test_coverage_active_file()</code>. I can also use <code>covr::package_coverage()</code> in the <strong>Console</strong> for simpler output:</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>utap Coverage: 100.00%</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>R/column_classes.R: 100.00%</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>R/pull_binary_cols.R: 100.00%</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>R/pull_cat_cols.R: 100.00%</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>R/pull_facet_cols.R: 100.00%</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>R/pull_numeric_cols.R: 100.00%</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>R/utils.R: 100.00%</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="other-metrics" class="level4">
<h4 class="anchored" data-anchor-id="other-metrics">Other metrics</h4>
<p>Sometimes it’s interesting to view the relationship between function size and number of tests using the <a href="https://github.com/hrbrmstr/cloc"><code>cloc</code> package.</a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cloc)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>cloc</code> stands for <em>Count Lines of Code</em>, and it’s a rough metric used to gauge code complexity. It’s simple, but apparently provides “<em>just as much predictive power as more elaborate constructs like cyclomatic complexity.</em>”<a href="https://www.oreilly.com/library/view/software-design-x-rays/9781680505795/">source</a></p>
<p>Below is a count of the lines of code in each file in the <code>R</code> folder:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>cloc<span class="sc">::</span><span class="fu">cloc_by_file</span>(<span class="st">"R"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="sourceCode" id="cb57"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a># A tibble: 8 × 6</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>  source filename                language   loc blank_lines comment_lines</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>  &lt;chr&gt;  &lt;chr&gt;                   &lt;chr&gt;    &lt;int&gt;       &lt;int&gt;         &lt;int&gt;</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>1 R      "R/pull_binary_cols.R"  R           53           2            57</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>2 R      "R/pull_facet_cols.R"   R           42           2            73</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>3 R      "R/column_classes.R"    R           41           6            65</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>4 R      "R/pull_numeric_cols.R" R           19           1            24</span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>5 R      "R/pull_cat_cols.R"     R           13           0            19</span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>6 R      "R/utils.R"             R            3           0             7</span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>7 R      "R/utap-package.R"      R            2           0             7</span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>8 R      ""                      SUM        173          11           252</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This output also confirms the relationship between lines of code and tests.</p>
</section>
</section>
</section>
<section id="recap" class="level2">
<h2 class="anchored" data-anchor-id="recap">Recap</h2>
<p>This post has been an introduction to unit testing utility functions in a shiny app-package. When I’m confident the utility functions are working, I’ll start adding them into modules (and testing with <code>testServer()</code> or <code>shinytest2</code>). Files names can change a lot throughout the course of developing a shiny app-package, so it’s helpful to adopt (or create) a naming convention.</p>
<p>If you’re using the <code>golem</code> framework to develop your shiny app-package, the <code>utils_</code> and <code>fct_</code> prefixes are used to define two different types of <a href="https://engineering-shiny.org/structuring-project.html#conventions-matter">utility/helper functions</a>:</p>
<ol type="1">
<li><p><code>utils_</code> files contain ‘<em>small helper functions</em> and’<em>top-level functions defining your user interface and your server function</em>’</p></li>
<li><p><code>fct_</code> files contain ‘<em>the business logic, which are potentially large functions</em>…<em>the backbone of the application and may not be specific to a given module</em>’.</p></li>
</ol>
<p>This particular file naming convention isn’t required, but as with most conventions, it’s better when someone else comes up with the standard (and I just have to adopt and implement it). And having and sticking to a naming convention is typically more important than the convention itself.</p>
<!--



````default
test-column_classes.R:
            │
            └── select_column_class()
                  │
                  └── get_column_class() 
````


````default
tree/
  │
  └── get_column_class()
        │     │
        │     └── select_column_class()
        │
        ├── pull_binary_cols()
        │
        ├── pull_facet_cols()
        │
        ├── pull_cat_cols()
        │
        └── pull_numeric_cols()
````


````default
tree/
  │
  └── get_column_class() # used in all pull_[type]_cols()
        │     │
        │     └── select_column_class()
        │
        ├── pull_binary_cols()
        │        │
        │        ├── check_binary_vec()
        │        │      │
        │        │      ├── check_log_binary()
        │        │      ├── check_int_binary()
        │        │      └── check_fct_binary()
        │        │
        │        └── make_binary_vec()
        │
        ├── pull_facet_cols() # custom definition
        │        │
        │        ├── check_facet_vec()
        │        │      │
        │        │      ├── check_chr_facet()
        │        │      └── check_fct_facet()
        │        │
        │        └── make_facet_vec()
        │
        ├── pull_cat_cols() # is.character & is.factor
        │
        └── pull_numeric_cols() # is.integer & is.double
````


-->


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>