<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.37">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Martin Frigaard">
<meta name="dcterms.date" content="2023-06-20">

<title>Testing Shiny modules – @mjfrigaard</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<script src="../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-29e2c20b02301cfff04dc8050bf30c7e.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap-7246a90fd7fce57841499c4ef90837f1.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="../../../site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="../../../site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="../../../site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="floating nav-fixed slimcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../../index.html">
    <span class="navbar-title"><span class="citation" data-cites="mjfrigaard">@mjfrigaard</span></span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../posts.html"> 
<span class="menu-text">Posts</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../books.html"> 
<span class="menu-text">Books</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../talks.html"> 
<span class="menu-text">Talks</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../articles.html"> 
<span class="menu-text">Articles</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../series.html"> 
<span class="menu-text">Series</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../code.html"> 
<span class="menu-text">Code</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/mjfrigaard"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/mjfrigaard"> <i class="bi bi-twitter" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Contents</h2>
   
  <ul>
  <li><a href="#testing-shiny-modules" id="toc-testing-shiny-modules" class="nav-link active" data-scroll-target="#testing-shiny-modules">Testing shiny modules</a></li>
  <li><a href="#a-shiny-app-package" id="toc-a-shiny-app-package" class="nav-link" data-scroll-target="#a-shiny-app-package">A Shiny App-Package</a></li>
  <li><a href="#modules" id="toc-modules" class="nav-link" data-scroll-target="#modules">Modules</a>
  <ul>
  <li><a href="#dataset-input-module" id="toc-dataset-input-module" class="nav-link" data-scroll-target="#dataset-input-module">1) Dataset input module</a></li>
  <li><a href="#selectvar-module" id="toc-selectvar-module" class="nav-link" data-scroll-target="#selectvar-module">2) selectVar module</a></li>
  <li><a href="#selectdatavar-module" id="toc-selectdatavar-module" class="nav-link" data-scroll-target="#selectdatavar-module">3) selectDataVar module</a></li>
  </ul></li>
  <li><a href="#standalone-app-functions" id="toc-standalone-app-functions" class="nav-link" data-scroll-target="#standalone-app-functions">Standalone App Functions</a>
  <ul>
  <li><a href="#datasetapp" id="toc-datasetapp" class="nav-link" data-scroll-target="#datasetapp">datasetApp</a></li>
  <li><a href="#selectvarapp" id="toc-selectvarapp" class="nav-link" data-scroll-target="#selectvarapp">selectVarApp</a></li>
  <li><a href="#selectdatavarapp" id="toc-selectdatavarapp" class="nav-link" data-scroll-target="#selectdatavarapp">selectDataVarApp</a></li>
  </ul></li>
  <li><a href="#testserver" id="toc-testserver" class="nav-link" data-scroll-target="#testserver">testServer()</a>
  <ul>
  <li><a href="#what-should-i-test" id="toc-what-should-i-test" class="nav-link" data-scroll-target="#what-should-i-test">What should I test?</a></li>
  <li><a href="#arguments" id="toc-arguments" class="nav-link" data-scroll-target="#arguments">Arguments</a></li>
  <li><a href="#testing-inputs" id="toc-testing-inputs" class="nav-link" data-scroll-target="#testing-inputs">Testing inputs</a>
  <ul>
  <li><a href="#setting-test-inputs" id="toc-setting-test-inputs" class="nav-link" data-scroll-target="#setting-test-inputs">Setting test inputs</a></li>
  </ul></li>
  <li><a href="#returned-values" id="toc-returned-values" class="nav-link" data-scroll-target="#returned-values">Returned values</a></li>
  <li><a href="#server-function-arguments" id="toc-server-function-arguments" class="nav-link" data-scroll-target="#server-function-arguments">Server function arguments</a>
  <ul>
  <li><a href="#testing-module-communication" id="toc-testing-module-communication" class="nav-link" data-scroll-target="#testing-module-communication">Testing module communication</a></li>
  </ul></li>
  <li><a href="#module-outputs" id="toc-module-outputs" class="nav-link" data-scroll-target="#module-outputs">Module outputs</a>
  <ul>
  <li><a href="#testing-nested-modules" id="toc-testing-nested-modules" class="nav-link" data-scroll-target="#testing-nested-modules">Testing nested modules</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#recap" id="toc-recap" class="nav-link" data-scroll-target="#recap">Recap</a></li>
  </ul>
</nav>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Testing Shiny modules</h1>
<p class="subtitle lead">Part 3 (series): module server functions and <code>testServer()</code></p>
  <div class="quarto-categories">
    <div class="quarto-category">shiny</div>
    <div class="quarto-category">testing</div>
  </div>
  </div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Martin Frigaard </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">June 20, 2023</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<div class="callout callout-style-default callout-important no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="true" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span style="font-weight: bold; font-size: 1.20em;">Updates to series</span>
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse show">
<div class="callout-body-container callout-body">
<div style="font-size: 1.10em; color: #282b2d;">
<p>This series on testing has been updated with recent changes in <code>testthat</code>, <code>shinytest2</code>, and other packages to improve testing.</p>
</div>
</div>
</div>
</div>
<p>This is the third post in a <a href="https://mjfrigaard.github.io/series.html">series on testing</a> shiny applications. I’ll cover testing shiny module server functions using the <a href="https://testthat.r-lib.org/"><code>testhat</code> package</a> and shiny’s <a href="https://shiny.rstudio.com/reference/shiny/1.7.0/testserver"><code>testServer()</code> function</a>.</p>
<section id="testing-shiny-modules" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="testing-shiny-modules">Testing shiny modules</h2>

<div class="no-row-height column-margin column-container"><div class="">
<p><a href="shiny.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1"><img src="shiny.png" class="img-fluid" style="width:40.0%"></a></p>
</div></div><p>Shiny functions pose a couple of unique challenges for testing. First, we can’t execute shiny <code>server</code> functions in the console. Second, as Shiny apps become more complex, it’s <a href="https://engineering-shiny.org/structuring-project.html#using-shiny-modules">highly</a> <a href="https://mastering-shiny.org/scaling-modules.html#module-motivation">recommended</a> to break up the code base into <a href="https://shiny.posit.co/r/articles/improve/modules/index.html">modules</a>. Modules have additional challenges due to their reactivity being split between interconnected UI and server functions.</p>
<p>The <code>shiny</code> package doesn’t provide a direct, built-in way to test modules, but the <a href="https://shiny.posit.co/r/articles/improve/server-function-testing/"><code>testServer()</code></a> function addresses these challenges by testing “<em>reactive interactions</em>” in module server functions. <code>testServer()</code> also works with <a href="https://testthat.r-lib.org/"><code>testthat</code></a>, which means we can structure these ‘reactive interaction’ tests just like other unit tests (for non-application functions).</p>
</section>
<section id="a-shiny-app-package" class="level2">
<h2 class="anchored" data-anchor-id="a-shiny-app-package">A Shiny App-Package</h2>
<p><code>testthat</code> is designed to work within an R package, and the <a href="https://github.com/mjfrigaard/sapkgs/tree/mstsap"><code>mstsap</code></a> branch of <code>sapkgs</code> has a <strong>M</strong>astering <strong>S</strong>hiny <strong>t</strong>est<strong>S</strong>erver <strong>a</strong>pp-<strong>p</strong>ackage to demonstrate writing tests with <code>testServer()</code>.</p>
<p>The functions, modules, and applications in <code>mstsap</code> come from the <a href="https://mastering-shiny.org/scaling-modules.html">Shiny Modules chapter</a> of Mastering Shiny.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> If you haven’t read this chapter–start there.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># to get the mstsap package used in this post:</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>devtools<span class="sc">::</span><span class="fu">load_all</span>()</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mstsap)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-tip no-icon callout-titled" title="Why create an app-package?">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Why create an app-package?
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div style="font-size: 1.10em;">
<p>A shiny app-package is a shiny application that’s been developed as (or converted to) an R package. The benefits of storing shiny apps in R packages have been <a href="https://mastering-shiny.org/scaling-packaging.html">well</a> <a href="https://engineering-shiny.org/structuring-project.html#shiny-app-as-a-package">documented</a>, but I’ll summarize just a few that are specific to testing:</p>
<ol type="1">
<li><strong>Standardized folder structure</strong>:
<ol type="a">
<li>If unit tests are performed with <code>testthat</code>, minimal setup is required to perform tests.</li>
<li><code>usethis::use_testthat()</code> sets up test files in the tests/testthat/ folder (to test the code in the R/ folder)<br>
</li>
<li><em>Read more about using <code>testthat</code> with R packages <a href="https://r-pkgs.org/testing-basics.html">here.</a></em></li>
</ol></li>
<li><strong>Test extras</strong>:
<ol type="a">
<li>Test data can be placed in <code>tests/testthat/&lt;test dir&gt;/&lt;test_data.rds&gt;</code><br>
</li>
<li>The code used to create the test data should be placed in <code>make_&lt;test_data.rds&gt;</code><br>
</li>
<li>Additional testing functions can be stored in <code>tests/testthat/helpers.R</code><br>
</li>
<li><em>Read more about test helpers <a href="https://r-pkgs.org/testing-design.html#testthat-helper-files">here.</a></em></li>
</ol></li>
<li><strong>Development tools</strong>:
<ol type="a">
<li>If you’re using RStudio, tests can be run individually (<code>testthat::test_file()</code>) or collectively (<code>devtools::test()</code>), and code helpers and data are loaded using <code>devtools::load_all()</code><br>
</li>
<li>Tests created with <code>testthat</code> remain isolated during development<br>
</li>
<li><em>Read more about developing packages with RStudio in the <a href="https://r-pkgs.org/">R Packages text.</a></em></li>
</ol></li>
</ol>
</div>
</div>
</div>
</div>
</section>
<section id="modules" class="level2">
<h2 class="anchored" data-anchor-id="modules">Modules</h2>
<p>In <a href="https://mjfrigaard.github.io/posts/p1-tests-unit-tests/">a previous post</a>, I used the following definition for unit tests,</p>
<blockquote class="blockquote">
<p>“<em>A unit test is a piece of code that invokes a unit of work and checks one specific end result of that unit of work.</em>” - <a href="https://www.manning.com/books/the-art-of-unit-testing-second-edition">The Art of Unit Testing, 2nd edition</a></p>
</blockquote>
<p>Shiny modules can also be broken into discrete ‘units of work’ with expected ‘end results.’ Modules are <a href="https://mastering-shiny.org/scaling-modules.html">‘<em>a pair of UI and server functions</em>’</a> designed to compartmentalize input and output IDs into distinct namespaces.<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></p>
<div class="callout callout-style-default callout-note no-icon callout-titled" title="Shiny module refresher">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Shiny module refresher
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Module UI functions typically wrap the layout, input, and output functions in <code>tagList()</code>. Module server functions contain the ‘backend’ code that typically goes in a shiny <code>server</code> function. Both the UI and server module functions are linked by an <code>id</code> argument, which is created using <code>NS()</code> (namespace) in the UI function, and called in the server function with <code>moduleServer()</code>.</p>
<section id="module-ui-functions" class="level3">
<h3 class="anchored" data-anchor-id="module-ui-functions">Module UI functions</h3>
<p>Below is an example module UI function:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>mod_fun_ui <span class="ot">&lt;-</span> <span class="cf">function</span>(id) {</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tagList</span>(</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">numericInput</span>(<span class="at">inputId =</span> <span class="fu">NS</span>(<span class="at">namespace =</span> id, <span class="at">id =</span> <span class="st">"num_input"</span>)),</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">uiOutput</span>(<span class="at">outputId =</span> <span class="fu">NS</span>(<span class="at">namespace =</span> id, <span class="at">id =</span> <span class="st">"num_out"</span>))</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li><p><code>mod_fun_ui</code> creates a dedicated namespace for one <code>inputId</code> and one <code>outputId</code> with <code>shiny::NS()</code>:</p>
<div class="cell">
<pre><code>█─mod_fun_ui 
├─id 
└─█─tagList 
  ├─█─numericInput 
  │ └─inputId = █─NS 
  │             ├─namespace = id 
  │             └─id = "num_input" 
  └─█─uiOutput 
    └─outputId = █─NS 
                 ├─namespace = id 
                 └─id = "num_out" </code></pre>
</div></li>
</ul>
</section>
<section id="module-server-functions" class="level3">
<h3 class="anchored" data-anchor-id="module-server-functions">Module server functions</h3>
<p>The corresponding module server function is below:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>mod_fun_server <span class="ot">&lt;-</span> <span class="cf">function</span>(id) {</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>        <span class="fu">moduleServer</span>(id, <span class="cf">function</span>(input, output, session) {</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>            ns <span class="ot">&lt;-</span> session</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>          output<span class="sc">$</span>num_out <span class="ot">&lt;-</span> <span class="fu">uiOutput</span>(<span class="at">outputId =</span> input<span class="sc">$</span>num_input)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li><p>The code to render the reactive <code>input$num_input</code> with <code>output$num_out</code> is contained in the nested call to <code>moduleServer()</code></p>
<div class="cell">
<pre><code>█─mod_fun_server 
├─id 
└─█─moduleServer 
  ├─id = id 
  ├─server = █─`function(input, output, session)` 
  │          ├─`ns &lt;- session` 
  │          ├─`output$num_out &lt;-` 
  │          └─█─renderUI 
  │            └─`input$num_input` 
  └─session = session </code></pre>
</div></li>
</ul>
</section>
<section id="using-modules" class="level3">
<h3 class="anchored" data-anchor-id="using-modules">Using modules</h3>
<p>Both module functions are combined in the <code>ui</code> and <code>server</code> arguments of <code>shinyApp()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">shinyApp</span>(</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">ui =</span> <span class="fu">fluidPage</span>(</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mod_fun_ui</span>(<span class="at">id =</span> <span class="st">"mod"</span>)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>   <span class="at">server =</span> <span class="cf">function</span>(input, output, session) </span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mod_fun_server</span>(<span class="st">"mod"</span>)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li><p>The <code>id</code> arguments connect the UI and server functions to communicate between the UI and backend of the app:</p>
<div class="cell">
<pre><code>█─shinyApp 
├─ui = █─fluidPage 
│      └─█─mod_fun_ui 
│        └─id = "mod namespace" 
└─server = █─`function(input, output, session)` 
           └─█─mod_fun_server 
             └─id = "mod namespace" </code></pre>
</div></li>
</ul>
<p>I recommend creating test files when you create module files (i.e., with <code>usethis::use_r()</code> &amp; <code>usethis::use_test()</code>).</p>
</section>
</div>
</div>
</div>
<p>However, the ‘unit of work’ for a Shiny module might be accomplished with a combination of a module UI and server functions, <em>and</em> a helper/utility function.</p>
<p><code>mstsap</code> contains three modules: <code>dataset</code>, <code>selectVar</code>, and <code>selectDataVar</code>. If you’re like more information on these modules, click on the links below.</p>
<section id="dataset-input-module" class="level3">
<h3 class="anchored" data-anchor-id="dataset-input-module">1) Dataset input module</h3>
<div>

</div>
<div class="quarto-layout-panel" data-layout="[65,35]">
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="quarto-layout-cell" style="flex-basis: 65.0%;justify-content: center;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="dataset.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2"><img src="dataset.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></a></p>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 35.0%;justify-content: flex-start;">
<p><a href="https://mastering-shiny.org/scaling-modules.html#getting-started-ui-input-server-output"><code>datasetInput</code></a>/<a href="https://mastering-shiny.org/scaling-modules.html#getting-started-ui-input-server-output"><code>datasetServer</code></a>: loads and returns data object from the <code>datasets</code> package (filtered by data frames or matrices)</p>
</div>
</div>
</div>
<p>The objects from <code>datasets</code> are filtered in the UI module function with a <code>filter</code> argument that can be used to <em>“limit the options to built-in datasets that are either data frames (<code>filter = is.data.frame</code>) or matrices (<code>filter = is.matrix</code>)”</em>. The <code>names</code> are passed to the <code>choices</code> in the <code>selectInput()</code>:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>show/hide choices in datasetInput()</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>names <span class="ot">&lt;-</span> <span class="fu">ls</span>(<span class="st">"package:datasets"</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(filter)) {</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    data <span class="ot">&lt;-</span> <span class="fu">lapply</span>(names, get, <span class="st">"package:datasets"</span>)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    names <span class="ot">&lt;-</span> names[<span class="fu">vapply</span>(data, filter, <span class="fu">logical</span>(<span class="dv">1</span>))]</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The <code>datasets</code> object is returned with <code>get()</code> (wrapped in <code>reactive()</code>). See below:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>show/hide returned data from datasetServer()</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>shiny<span class="sc">::</span><span class="fu">reactive</span>(</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>      <span class="fu">get</span>(input<span class="sc">$</span>dataset, <span class="st">"package:datasets"</span>)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="selectvar-module" class="level3">
<h3 class="anchored" data-anchor-id="selectvar-module">2) selectVar module</h3>
<div>

</div>
<div class="quarto-layout-panel" data-layout="[65,35]">
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="quarto-layout-cell" style="flex-basis: 65.0%;justify-content: center;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="selectVar.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3"><img src="selectVar.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></a></p>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 35.0%;justify-content: flex-start;">
<p><a href="https://mastering-shiny.org/scaling-modules.html#case-study-selecting-a-numeric-variable"><code>selectVarInput</code></a>/<a href="https://mastering-shiny.org/scaling-modules.html#server-inputs"><code>selectVarServer</code></a>: displays a <code>selectInput()</code> that “<em>allows the user to select variables of specified type from a given reactive dataset.</em>”</p>
</div>
</div>
</div>
<p>The <code>data</code> argument in <code>selectVarServer()</code> is the returned value from <code>datasetServer()</code>. The <code>data()</code> is used with the <code>filter</code> argument in the <code>find_vars()</code> function:</p>
<div class="cell">
<details class="code-fold">
<summary>show/hide find_vars()</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>find_vars <span class="ot">&lt;-</span> <span class="cf">function</span>(data, filter) {</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a> <span class="co"># I've included the updated version with the 'stopifnot()' checks!</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">is.data.frame</span>(data))</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">is.function</span>(filter))</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(data)[<span class="fu">vapply</span>(data, filter, <span class="fu">logical</span>(<span class="dv">1</span>))]</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The filter argument can be used to return variables by class/type (using <code>is.*</code> functions like <code>is.numeric()</code> or <code>is.character()</code>).</p>
<p>When <code>data()</code> changes, the output from <code>find_vars()</code> updates the choices in the variable <code>selectInput()</code> (i.e., <code>input$var</code>). See below:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="selectVar_find_vars.png" class="lightbox" data-gallery="quarto-lightbox-gallery-4"><img src="selectVar_find_vars.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%"></a></p>
</figure>
</div>
<p><code>selectVarServer()</code> also returns the selected variable (<code>input$var</code>) as a reactive value (<code>var()</code>)</p>
</section>
<section id="selectdatavar-module" class="level3">
<h3 class="anchored" data-anchor-id="selectdatavar-module">3) selectDataVar module</h3>
<div>

</div>
<div class="quarto-layout-panel" data-layout="[65,35]">
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="quarto-layout-cell" style="flex-basis: 65.0%;justify-content: center;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="selectDataVar.png" class="lightbox" data-gallery="quarto-lightbox-gallery-5"><img src="selectDataVar.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></a></p>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 35.0%;justify-content: flex-start;">
<p><a href="https://mastering-shiny.org/scaling-modules.html#modules-inside-of-modules"><code>selectDataVarUI</code></a>/<a href="https://mastering-shiny.org/scaling-modules.html#modules-inside-of-modules"><code>selectDataVarServer</code></a>: The <code>selectDataVar</code> module is from the section titled, “<a href="https://mastering-shiny.org/scaling-modules.html#modules-inside-of-modules"><em>Modules inside of modules</em></a>”, so here we see the <code>dataset</code> and <code>selectVar</code> modules placed <em>inside</em> the <code>selectDataVar</code> module (each with a new namespace (<code>NS()</code>)).</p>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled" title="Naming modules">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-4-contents" aria-controls="callout-4" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Naming modules
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-4" class="callout-4-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div style="font-size: 1.15em; color: #063E23;">
<p>When creating an app-packages, modules are stored in the <code>R/</code> folder as a single file, typically following a <a href="https://mastering-shiny.org/scaling-modules.html#naming-conventions">naming convention</a> that differentiates modules from the other package functions. The modules in this post use <a href="https://en.wikipedia.org/wiki/Camel_case">camelCase</a>, with suffix variations (i.e., <code>Input</code>/<code>Server</code> and <code>UI</code>/<code>Server</code>) for each functions. Other options come from the <a href="https://thinkr-open.github.io/golem/"><code>golem</code></a> and <a href="https://leprechaun.opifex.org/#/"><code>leprechaun</code></a> packages.</p>
<p><code>golem</code> modules are created with <a href="https://thinkr-open.github.io/golem/reference/add_module.html"><code>golem::add_module()</code></a></p>
</div>
<div class="cell">
<details class="code-fold">
<summary>expand to see golem::add_module(“inputs”)</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>mod_inputs_ui <span class="ot">&lt;-</span> <span class="cf">function</span>(id){</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  ns <span class="ot">&lt;-</span> <span class="fu">NS</span>(id)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tagList</span>(</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>mod_inputs_server <span class="ot">&lt;-</span> <span class="cf">function</span>(id){</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">moduleServer</span>( id, <span class="cf">function</span>(input, output, session){</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    ns <span class="ot">&lt;-</span> session<span class="sc">$</span>ns</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="do">## To be copied in the UI</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="co"># mod_inputs_ui("inputs_1")</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a><span class="do">## To be copied in the server</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a><span class="co"># mod_inputs_server("inputs_1")</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div style="font-size: 1.15em; color: #063E23;">
<p><code>golem</code> modules the following naming convention:</p>
<ol type="1">
<li><p>All new module functions have a <code>mod_</code> prefix</p></li>
<li><p><code>golem</code> module functions are differentiated with either a <code>_ui</code> or <code>_server</code> suffix</p></li>
<li><p>New <code>golem</code> module files are named <code>R/mod_&lt;name&gt;.R</code></p></li>
</ol>
<p><code>leprechaun</code> modules are also created with a <a href="https://leprechaun.opifex.org/#/reference/add_module"><code>leprechaun::add_module()</code></a> function.</p>
</div>
<div class="cell">
<details class="code-fold">
<summary>expand to see leprechaun::add_module(“inputs”)</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>inputsUI <span class="ot">&lt;-</span> <span class="cf">function</span>(id){</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    ns <span class="ot">&lt;-</span> <span class="fu">NS</span>(id)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tagList</span>(</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">h2</span>(<span class="st">"inputs"</span>)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>inputs_server <span class="ot">&lt;-</span> <span class="cf">function</span>(id){</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">moduleServer</span>(id, <span class="cf">function</span>(input, output, session) {</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>                ns <span class="ot">&lt;-</span> session<span class="sc">$</span>ns</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>                send_message <span class="ot">&lt;-</span> <span class="fu">make_send_message</span>(session)</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>                <span class="co"># your code here</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a><span class="co"># UI</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a><span class="co"># inputsUI('id')</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a><span class="co"># server</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a><span class="co"># inputs_server('id')</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div style="font-size: 1.15em; color: #063E23;">
<p><code>leprechaun</code> modules have a slightly different naming convention:</p>
<ol type="1">
<li><p>All new UI module functions have a <code>UI</code> suffix</p></li>
<li><p>All new module server functions have a <code>_server</code> suffix</p></li>
<li><p><code>leprechaun</code> module functions <em>do not have a prefix</em></p></li>
<li><p>New <code>leprechaun</code> modules named <code>module_&lt;name&gt;.R</code></p></li>
</ol>
<p>Shiny app-packages often require multiple modules and utility functions, so uniform names will make it easier to manage (and test!) your code.</p>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="standalone-app-functions" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="standalone-app-functions">Standalone App Functions</h2>
<p><code>mstsap</code> contains three <a href="https://mastering-shiny.org/scaling-packaging.html#converting-an-existing-app">standalone functions</a> for running each set of module functions.</p>
<p>I’ve made a small change to each standalone app function–each app has a call to <code>reactiveValuesToList()</code> that displays in the UI.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>print reactive values</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>  shiny<span class="sc">::</span><span class="fu">verbatimTextOutput</span>(<span class="st">"vals"</span>)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  output<span class="sc">$</span>vals <span class="ot">&lt;-</span> shiny<span class="sc">::</span><span class="fu">renderPrint</span>({</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> shiny<span class="sc">::</span><span class="fu">reactiveValuesToList</span>(input,</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>                            <span class="at">all.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(x)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  })</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="datasetapp" class="level3">
<h3 class="anchored" data-anchor-id="datasetapp">datasetApp</h3>
<div>

</div>
<div class="quarto-layout-panel" data-layout="[65,35]">
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="quarto-layout-cell" style="flex-basis: 65.0%;justify-content: center;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="datasetApp.png" class="lightbox" data-gallery="quarto-lightbox-gallery-6"><img src="datasetApp.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></a></p>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 35.0%;justify-content: flex-start;">
<p><code>datasetApp()</code> contains a call to the <code>dataset</code> module, and includes a <code>tableOutput()</code> to render the selected data object:</p>
</div>
</div>
</div>
<p>When <code>datasetApp()</code> is run, the app displays the dataset object in the <code>tableOutput()</code>, and the <code>verbatimTextOutput()</code> renders the reactive values as a text:</p>
<div id="fig-datasetApp_run" class="quarto-float quarto-figure quarto-figure-center anchored" width="100%" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-datasetApp_run-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="datasetApp_run.png" class="lightbox" data-gallery="quarto-lightbox-gallery-7" title="Figure&nbsp;1: "><img src="datasetApp_run.png" id="fig-datasetApp_run" class="img-fluid quarto-figure quarto-figure-center anchored figure-img" style="width:100.0%"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-datasetApp_run-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1
</figcaption>
</figure>
</div>
<p>The output above shows what <code>NS()</code> does in the <code>dataset</code> module–it appends the module <code>id</code> argument to the <code>inputId</code> (which is why we see <code>dataset-dataset</code>).</p>
<ul>
<li><p><strong><code>dataset-</code>:</strong> the module id</p></li>
<li><p><strong><code>dataset-dataset</code></strong> the <code>inputId</code> from the <code>selectInput()</code></p></li>
</ul>
</section>
<section id="selectvarapp" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="selectvarapp">selectVarApp</h3>
<div>

</div>
<div class="quarto-layout-panel" data-layout="[65,35]">
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="quarto-layout-cell" style="flex-basis: 65.0%;justify-content: center;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="selectVarApp.png" class="lightbox" data-gallery="quarto-lightbox-gallery-8"><img src="selectVarApp.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></a></p>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 35.0%;justify-content: flex-start;">
<p><code>selectVarApp()</code> includes both <code>dataset</code> and <code>selectVar</code> modules, but instead of rendering the output in a table, the UI renders the variable output in a <code>verbatimTextOutput()</code>.</p>
</div>
</div>
</div>
<p>Note that <code>selectVarApp()</code> contains namespaces for two modules:</p>
<ol type="1">
<li><p><strong><code>"data"</code></strong>: the namespace for the <code>datasetnput()</code> and <code>datasetServer()</code> modules, inheriting the <code>filter</code> argument and creating the data object</p></li>
<li><p><strong><code>"var"</code></strong>: the <code>selectVar</code> modules are linked with the <code>"var"</code> id. <code>selectVarServer()</code> uses the <code>data</code> object created by <code>datasetServer()</code> (and also inherits the <code>filter</code> argument).</p></li>
</ol>
<p>These namespaced IDs are rendered below with <code>reactiveValuesToList()</code>:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="selectVarApp_run.png" class="lightbox" data-gallery="quarto-lightbox-gallery-9"><img src="selectVarApp_run.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%"></a></p>
</figure>
</div>
<p>There’s a lot happening in <code>selectVarApp()</code>, so I’ve created the figure below to display the code for the modules with their displayed outputs:</p>
<div class="page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p class="page-columns page-full"><a href="selectVarApp_schema.png" class="lightbox page-columns page-full" data-gallery="quarto-lightbox-gallery-10"><img src="selectVarApp_schema.png" class="img-fluid quarto-figure quarto-figure-center figure-img column-page-inset-right" style="width:100.0%"></a></p>
</figure>
</div>
</div>
<p>As we can see, the <code>data</code> output from the <code>dataset</code> module is used to generate the <code>vars()</code> reactive for the <code>verbatimTextOutput()</code> in <code>selectVarApp()</code>. Note that both <code>dataset</code> and <code>selectVar</code> modules don’t contain any output functions–these have been provided in the UI for both <code>datasetApp()</code> and <code>selectVarApp()</code>.</p>
</section>
<section id="selectdatavarapp" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="selectdatavarapp">selectDataVarApp</h3>
<div>

</div>
<div class="quarto-layout-panel" data-layout="[65,35]">
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="quarto-layout-cell" style="flex-basis: 65.0%;justify-content: center;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="selectDataVarApp.png" class="lightbox" data-gallery="quarto-lightbox-gallery-11"><img src="selectDataVarApp.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></a></p>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 35.0%;justify-content: flex-start;">
<p>The final app in <code>mstsap</code> is <code>selectDataVarApp()</code>. Here the inputs from <code>dataset</code> and <code>selectVar</code> have been moved into the <code>sidebarPanel()</code>, and the output is rendered in the <code>mainPanel()</code>.</p>
</div>
</div>
</div>
<p>The reactive values here show how the <a href="https://mastering-shiny.org/scaling-modules.html#modules-inside-of-modules">‘Modules inside of modules’</a> work–by adding the additional call to <code>NS()</code> in the <code>datasetInput()</code> and <code>selectVarInput()</code> functions <em>within</em> <code>selectDataVarUI()</code> and <code>selectDataVarServer()</code>, an additional namespace is appended to the reactive values (<code>input$dataset</code> and <code>input$var</code>):</p>
<div id="fig-selectDataVarApp_run" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-selectDataVarApp_run-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div id="fig-selectDataVarApp_run" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-selectDataVarApp_run-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="selectDataVarApp_run.png" class="lightbox" data-gallery="fig-selectDataVarApp_run" title="Figure&nbsp;2&nbsp;(a): selectDataVarApp with reactive values"><img src="selectDataVarApp_run.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%" data-ref-parent="fig-selectDataVarApp_run"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-selectDataVarApp_run-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) <code>selectDataVarApp</code> with reactive values
</figcaption>
</figure>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-selectDataVarApp_run-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: <code>selectDataVarApp</code> with <code>reactiveValuesToList()</code>
</figcaption>
</figure>
</div>
<p>Below is a figure that displays the contents of the <code>selectDataVar</code> modules (I’ve removed the <code>tagList()</code> and <code>moduleServer()</code> for simplicity), the <code>selectDataVarApp()</code>, and the rendered outputs:</p>
<div class="page-columns page-full">
<div id="fig-selectDataVarApp_schema" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full">
<figure class="quarto-float quarto-float-fig figure page-columns page-full">
<div aria-describedby="fig-selectDataVarApp_schema-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca" class="page-columns page-full">
<div id="fig-selectDataVarApp_schema" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full" data-fig-align="center">
<figure class="quarto-float quarto-subfloat-fig figure page-columns page-full">
<div aria-describedby="fig-selectDataVarApp_schema-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca" class="page-columns page-full">
<a href="selectDataVarApp_schema.png" class="lightbox page-columns page-full" data-gallery="fig-selectDataVarApp_schema" title="Figure&nbsp;3&nbsp;(a): selectDataVarApp schema"><img src="selectDataVarApp_schema.png" class="img-fluid quarto-figure quarto-figure-center figure-img column-page-right" style="width:100.0%" data-ref-parent="fig-selectDataVarApp_schema"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-selectDataVarApp_schema-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) <code>selectDataVarApp</code> schema
</figcaption>
</figure>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-selectDataVarApp_schema-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: <code>dataset</code> and <code>selectVar</code> modules inside <code>selectDataVar</code> module with rendered outputs
</figcaption>
</figure>
</div>
</div>
</section>
</section>
<section id="testserver" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="testserver">testServer()</h2>
<p>Module server functions can be tested the same way as a traditional shiny <code>server</code> function, as long as you provide the inputs and verify the correct outputs. Below I’ll cover some general advice on module server tests (and the arguments in <code>testServer()</code>).</p>
<section id="what-should-i-test" class="level3">
<h3 class="anchored" data-anchor-id="what-should-i-test">What should I test?</h3>
<p>The best bit of advice I’ve found helpful when writing tests comes from <a href="https://r-pkgs.org/testing-design.html#what-to-test">R Packages</a>,</p>
<blockquote class="blockquote">
<p><em>“focus your time on code that you’re not sure about, is fragile, or has complicated interdependencies”</em></p>
</blockquote>
<p>The quote isn’t in reference to testing modules or Shiny application functions, but I’ve found it’s easy to fall into the trap of trying to test <em>everything</em> when a targeted approach is more efficient (and equally valid).</p>
<p>The items below have been compiled from <a href="https://mastering-shiny.org/scaling-testing.html#basic-workflow">Mastering Shiny</a>, <a href="https://r-pkgs.org/testing-design.html#what-to-test">R Packages</a>, and <a href="https://engineering-shiny.org/build-yourself-safety-net.html#testing-your-app">Engineering Production-Grade Shiny Apps</a>:</p>
<ol type="1">
<li><strong><em>Do the inputs/outputs behave as expected?</em></strong>
<ul>
<li>These tests verify the module server function <code>inputId</code>s and <code>outputId</code>s are properly namespaced and accessible</li>
</ul></li>
<li><strong><em>Does the module contain the expected reactive values/objects?</em></strong>
<ul>
<li>Tests should verify it’s reactivity–module server functions will automatically recompute the outputs when it’s inputs change, so tests should verify changes to inputs produce the expected behaviors and outputs. This includes any returned values from the module (and any additional function arguments).</li>
</ul></li>
<li><strong><em>Are the calculations correct?</em></strong>
<ul>
<li>If the module server function performs calculations or data manipulations, the tests should verify the module produces the correct result (ideally for a variety of inputs and edge cases).</li>
</ul></li>
<li><strong><em>How are errors handled in the module?</em></strong>
<ul>
<li>What errors are displayed from the module? Tests should simulate scenarios that can test if the module: 1) returns errors that are informative, 2) fails silently (when appropriate), or 3) falls back to the correct default behavior.</li>
</ul></li>
</ol>
<p>The first test I’ll perform is for <code>datasetServer()</code>, the module used to return a data object from the <code>datasets</code> package.</p>
</section>
<section id="arguments" class="level3">
<h3 class="anchored" data-anchor-id="arguments">Arguments</h3>
<p><code>testServer()</code> has the following arguments:</p>
<ul>
<li><p><code>app</code> can be a module server function (i.e., <code>datasetServer</code>), or any <a href="https://shiny.posit.co/r/reference/shiny/1.7.0/shiny.appobj.html"><code>shiny.appobj</code></a></p></li>
<li><p><code>expr</code> is where I’ll add the <code>testthat</code> expectations and other test code</p></li>
<li><p><code>args</code> is a <code>list()</code> I can use to include any module server function arguments</p></li>
</ul>
</section>
<section id="testing-inputs" class="level3">
<h3 class="anchored" data-anchor-id="testing-inputs">Testing inputs</h3>
<p>I’ll start by testing if the initial input value (<code>input$dataset</code>) in <code>datasetServer()</code> is set to <code>NULL</code>. The module server function is the first argument in <code>testServer()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">testServer</span>(<span class="at">app =</span> datasetServer, <span class="at">expr =</span> {</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(input<span class="sc">$</span>dataset, <span class="cn">NULL</span>)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">datasetServer: dataset$input is NULL"</span>, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li><p>Add custom messages with <code>cat()</code> and the <code>inputId</code> we’re testing. Then load, document, and install the package</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>devtools::load_all()</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>ℹ Loading mstsap</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>devtools::document()</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>ℹ Updating mstsap documentation</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>ℹ Loading mstsap</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>Restarting R session...</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>library(mstsap)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>And run the test with <code>testthat::test_file()</code>:</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">test_file</span>(<span class="st">"tests/testthat/test-datasetServer.R"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="sourceCode" id="cb17"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>[ FAIL 0 | WARN 0 | SKIP 0 | PASS 1 ]</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>datasetServer: dataset$input is NULL </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul>
<div class="callout callout-style-default callout-note no-icon callout-titled" title="Test comments with `testServer()`">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-5-contents" aria-controls="callout-5" aria-expanded="true" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Test comments with <code>testServer()</code>
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-5" class="callout-5-contents callout-collapse collapse show">
<div class="callout-body-container callout-body">
<div style="font-size: 1.10em;">
<p>The <code>testServer()</code> documentation has <a href="https://shiny.posit.co/r/articles/improve/server-function-testing/">examples</a> of using <code>cat()</code> to create custom messages. I put a function for creating <code>testServer()</code> messages (<code>test_cmt()</code>) in the <a href="https://github.com/mjfrigaard/mstsap/blob/main/tests/testthat/helper.R"><code>helper.R</code></a> file (<a href="https://r-pkgs.org/testing-advanced.html">read more about test helpers here</a>).</p>
<p>It has two arguments (<code>test</code> and <code>msg</code>), and makes it easy to print messages to the console while I’m developing tests.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">test_cmt</span>(<span class="at">test =</span> <span class="st">"mod_server_function"</span>, <span class="at">msg =</span> <span class="st">"test contents"</span>)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>       mod_server_function<span class="sc">:</span> test contents </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
</div>
<section id="setting-test-inputs" class="level4">
<h4 class="anchored" data-anchor-id="setting-test-inputs">Setting test inputs</h4>
<p><code>testServer()</code> allows us to mimic changing application (or module) <code>inputId</code>s with <code>session$setInputs()</code> like so:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>session<span class="sc">$</span><span class="fu">setInputs</span>(<span class="at">inputId =</span> <span class="st">"value"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Below is a test for <code>input$dataset</code> in <code>datasetServer()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>  session<span class="sc">$</span><span class="fu">setInputs</span>(<span class="at">dataset =</span> <span class="st">"faithful"</span>)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">object =</span> input<span class="sc">$</span>dataset,</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">expected =</span> <span class="st">"faithful"</span>)</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">test_cmt</span>(<span class="st">"datasetServer"</span>, <span class="st">"dataset$input"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="returned-values" class="level3">
<h3 class="anchored" data-anchor-id="returned-values">Returned values</h3>
<p>Any returned values from module server functions can be accessed in <code>testServer()</code> with <a href="https://shiny.posit.co/r/articles/improve/server-function-testing/#modules-with-return-values"><code>session$returned()</code></a>. I’ll verify <code>input$dataset</code> returns an object from <code>datasetServer()</code> by testing the class of <code>session$returned()</code>:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>show/hide test with session$returned()</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>  session<span class="sc">$</span><span class="fu">setInputs</span>(<span class="at">dataset =</span> <span class="st">"airquality"</span>)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">object =</span> <span class="fu">class</span>(session<span class="sc">$</span><span class="fu">returned</span>()),</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">expected =</span> <span class="st">"data.frame"</span>)</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">test_cmt</span>(<span class="st">"datasetServer"</span>, <span class="st">"class(session$returned())"</span>)</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>  session<span class="sc">$</span><span class="fu">setInputs</span>(<span class="at">dataset =</span> <span class="st">"WorldPhones"</span>)</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_true</span>(</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">object =</span> <span class="fu">is.matrix</span>(session<span class="sc">$</span><span class="fu">returned</span>()))</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">test_cmt</span>(<span class="st">"datasetServer"</span>, <span class="st">"is.matrix(session$returned())"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Note that both methods above can be used to check the class of the returned object.</p>
<ul>
<li><p>I can also use the <code>typeof(datasets::mtcars)</code> for a direct comparison:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>show/hide test with session$returned()</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>  session<span class="sc">$</span><span class="fu">setInputs</span>(<span class="at">dataset =</span> <span class="st">"mtcars"</span>)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># app value...</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">object =</span> <span class="fu">typeof</span>(session<span class="sc">$</span><span class="fu">returned</span>()), </span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ...compared to actual output</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">expected =</span> <span class="fu">typeof</span>(datasets<span class="sc">::</span>mtcars)) </span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">test_cmt</span>(<span class="st">"datasetServer"</span>, <span class="st">"typeof(session$returned())"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div></li>
</ul>
</section>
<section id="server-function-arguments" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="server-function-arguments">Server function arguments</h3>
<p>If the module server function has additional arguments beyond <code>id</code>, then it has additional functionality to verify with unit tests. To test additional module server arguments, pass these to <a href="https://shiny.posit.co/r/articles/improve/server-function-testing/#modules-with-additional-parameters"><code>testServer(args = list())</code>.</a> The <code>args</code> list should include named arguments from the module server function, i.e., <code>list(param1 = "value1", param2 = "value2")</code>.</p>
<p>For example, <code>selectVarServer()</code> has <code>data</code> and <code>filter</code> arguments:</p>
<ul>
<li><p><code>data</code> is the returned reactive object from <code>datasetServer()</code></p></li>
<li><p><code>filter</code> is the function passed to the <code>find_vars()</code> utility function</p></li>
</ul>
<div class="page-columns page-full">
<div id="fig-dataset_selectVar" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full">
<figure class="quarto-float quarto-float-fig figure page-columns page-full">
<div aria-describedby="fig-dataset_selectVar-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca" class="page-columns page-full">
<div id="fig-dataset_selectVar" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full" data-fig-align="center">
<figure class="quarto-float quarto-subfloat-fig figure page-columns page-full">
<div aria-describedby="fig-dataset_selectVar-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca" class="page-columns page-full">
<a href="dataset_selectVar.png" class="lightbox page-columns page-full" data-gallery="fig-dataset_selectVar" title="Figure&nbsp;4&nbsp;(a): dataset() -> selectVar()"><img src="dataset_selectVar.png" class="img-fluid quarto-figure quarto-figure-center figure-img column-body-outset-right" style="width:100.0%" data-ref-parent="fig-dataset_selectVar"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-dataset_selectVar-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) <code>dataset()</code> -&gt; <code>selectVar()</code>
</figcaption>
</figure>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-dataset_selectVar-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4: Object returned from <code>datasetServer()</code> and passed to <code>selectVarServer()</code>
</figcaption>
</figure>
</div>
</div>
<p>Below is a test for <code>selectVarServer()</code> using <code>args</code> to verify the reactive <code>data()</code> is <code>datasets::mtcars</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">testServer</span>(selectVarServer,</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">args =</span> <span class="fu">list</span>(<span class="at">data =</span> mtcars,</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>              <span class="at">filter =</span> is.numeric), <span class="at">expr =</span> {</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_true</span>(</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">object =</span> <span class="fu">is.reactive</span>(data))</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">test_cmt</span>(<span class="st">"selectVarServer"</span>, <span class="st">"is.reactive(data())"</span>)</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div style="font-size: 1.15em; font-style: italic; font-weight: bold; color: #A20025;">
<p>But this fails with the following error:</p>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">test_file</span>(<span class="st">"tests/testthat/test-selectVarServer.R"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="sourceCode" id="cb25"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>[ FAIL 1 | WARN 0 | SKIP 0 | PASS 0 ]</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>── Error (test-selectVarServer.R:1:1): (code run outside of `test_that()`) ───</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>Error in `(function (id, data, filter = is.numeric) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div style="font-size: 1.15em; font-style: italic; font-weight: bold; color: #006CD9;">
<p>What happened?</p>
</div>
<p>I’ve included this example because it’s not in the <a href="https://shiny.posit.co/r/articles/improve/server-function-testing/#testing-shiny-modules"><code>testServer()</code> documentation</a>, and it’s common to pass values between modules (see <a href="https://engineering-shiny.org/structuring-project.html#a.-returning-values-from-the-module">here in Engineering Production-Grade Shiny Apps</a> and <a href="https://mastering-shiny.org/scaling-modules.html#inputs-and-outputs">here in Mastering Shiny</a>)</p>
<section id="testing-module-communication" class="level4">
<h4 class="anchored" data-anchor-id="testing-module-communication">Testing module communication</h4>
<p>The error message above tells me the issue is originating from the <code>stopifnot()</code> calls in <code>selectVarServer()</code>.</p>
<div class="callout callout-style-default callout-important no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-6-contents" aria-controls="callout-6" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Updating selectVarServer() and find_vars()
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-6" class="callout-6-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div style="font-size: 1.10em;">
<p>Both <code>selectVarServer()</code> and <code>find_vars()</code> are updated from their original versions to include <code>stopifnot()</code> checks for <code>is.reactive()</code>, <code>is.data.frame()</code> and <code>is.function()</code>:</p>
<ul>
<li><p><a href="https://mastering-shiny.org/scaling-modules.html#server-inputs">Original versions:</a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>find_vars <span class="ot">&lt;-</span> <span class="cf">function</span>(data, filter) {</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(data)[<span class="fu">vapply</span>(data, filter, <span class="fu">logical</span>(<span class="dv">1</span>))]</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>selectVarServer <span class="ot">&lt;-</span> <span class="cf">function</span>(id, data, <span class="at">filter =</span> is.numeric) {</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">moduleServer</span>(id, <span class="cf">function</span>(input, output, session) {</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">observeEvent</span>(<span class="fu">data</span>(), {</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">updateSelectInput</span>(session, <span class="st">"var"</span>, <span class="at">choices =</span> <span class="fu">find_vars</span>(<span class="fu">data</span>(), filter))</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">reactive</span>(<span class="fu">data</span>()[[input<span class="sc">$</span>var]])</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></li>
<li><p><a href="https://mastering-shiny.org/scaling-modules.html#server-inputs">Updated versions:</a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>selectVarServer <span class="ot">&lt;-</span> <span class="cf">function</span>(id, data, <span class="at">filter =</span> is.numeric) {</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">is.reactive</span>(data))</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="sc">!</span><span class="fu">is.reactive</span>(filter))</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">moduleServer</span>(id, <span class="cf">function</span>(input, output, session) {</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">observeEvent</span>(<span class="fu">data</span>(), {</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>      <span class="fu">updateSelectInput</span>(<span class="at">session =</span> session, </span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">inputId =</span> <span class="st">"var"</span>, </span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">choices =</span> <span class="fu">find_vars</span>(<span class="fu">data</span>(), filter)</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">reactive</span>(<span class="fu">data</span>()[[input<span class="sc">$</span>var]])</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>find_vars <span class="ot">&lt;-</span> <span class="cf">function</span>(data, filter) {</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">is.data.frame</span>(data))</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">is.function</span>(filter))</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(data)[<span class="fu">vapply</span>(data, filter, <span class="fu">logical</span>(<span class="dv">1</span>))]</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></li>
</ul>
</div>
</div>
</div>
</div>
<p>I’ll stop a moment here to address what’s happening in each module:</p>
<ol type="1">
<li><p>The <code>datasetServer()</code> returns the results of <code>input$dataset</code> as a reactive (<code>data()</code>)</p></li>
<li><p><code>data()</code> enters <code>selectVarServer()</code> in the <code>data</code> argument</p></li>
<li><p><em>Inside</em> <code>selectVarServer()</code>, two <code>stopifnot()</code> functions evaluate the reactivity of <code>data</code> and <code>filter</code> with <code>shiny::is.reactive()</code></p></li>
</ol>
<p>In <code>datasetServer()</code>, the return object is <a href="https://github.com/mjfrigaard/mstsap/blob/f10e497df195cfa188afd031e7d082ed1466989d/R/datasetServer.R#L20">wrapped in the <code>reactive()</code> function</a>, so the items <code>args = list()</code> also need to be wrapped in <code>reactive()</code>.</p>
<p>I’ll re-write the test above to a more basic test using <code>is.reactive()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">testServer</span>(selectVarServer,</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">args =</span> <span class="fu">list</span>(<span class="at">data =</span> <span class="fu">reactive</span>(mtcars), </span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>              <span class="at">filter =</span> is.numeric), <span class="at">expr =</span> {</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_true</span>(</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">object =</span> <span class="fu">is.reactive</span>(<span class="fu">data</span>()))</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">test_cmt</span>(<span class="st">"selectVarServer"</span>, <span class="st">"is.reactive(data())"</span>)</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">test_file</span>(<span class="st">"tests/testthat/test-selectVarServer.R"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="sourceCode" id="cb32"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>[ FAIL 1 | WARN 0 | SKIP 0 | PASS 0 ]</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>       selectVarServer: is.reactive(data()) </span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>── Failure (test-selectVarServer.R:1:1): (code run outside of `test_that()`) ───</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>is.reactive(data()) is not TRUE</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>`actual`:   FALSE</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>`expected`: TRUE </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div style="font-size: 1.15em; font-style: italic; font-weight: bold; color: #A20025;">
<p><strong><em>Another failure???</em></strong></p>
</div>
<p>The results of this test might seem confusing given my advice to wrap the <code>args</code> list in <code>reactive()</code>, but some reading of the <code>x</code> argument in <code>is.reactive()</code> will clear up the error:</p>
<blockquote class="blockquote">
<p><em>For <code>is.reactive()</code>, an object to test. For <code>reactive()</code>, an expression.</em></p>
</blockquote>
<p>Removing the parentheses from <code>data()</code> will result in the proper test results:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">testServer</span>(selectVarServer,</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">args =</span> <span class="fu">list</span>(<span class="at">data =</span> <span class="fu">reactive</span>(mtcars), </span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>              <span class="at">filter =</span> is.numeric), <span class="at">expr =</span> {</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_true</span>(</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">object =</span> <span class="fu">is.reactive</span>(data))</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">test_cmt</span>(<span class="st">"selectVarServer"</span>, <span class="st">"is.reactive(data())"</span>)</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">test_file</span>(<span class="st">"tests/testthat/test-selectVarServer.R"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="sourceCode" id="cb35"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>[ FAIL 0 | WARN 0 | SKIP 0 | PASS 1 ]</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>       selectVarServer: is.reactive(data()) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Now that I have a reactive <code>data()</code> input, I can explore how this value is used inside <code>selectVarServer()</code>. To update <code>input$var</code>, the <code>data()</code> input is passed to <code>find_vars()</code> (a function that uses a <code>filter</code> argument “<em>used to select which variables to list</em>”). See the example below:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">find_vars</span>(</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> chickwts, </span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">filter =</span> is.factor)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="sourceCode" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] "feed"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>I’ll write an expectation that captures the behavior of <code>find_vars()</code> in <code>selectVarServer()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">testServer</span>(selectVarServer,</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">args =</span> <span class="fu">list</span>(<span class="at">data =</span> <span class="fu">reactive</span>(chickwts),</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>              <span class="at">filter =</span> is.numeric), <span class="at">expr =</span> {</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">object =</span> <span class="fu">find_vars</span>(<span class="fu">data</span>(), is.factor),</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">expected =</span> <span class="st">"feed"</span>)</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">test_cmt</span>(<span class="st">"selectVarServer"</span>, <span class="st">"find_vars()"</span>)</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To verify that the returned object from <code>selectVarServer()</code> is the selected column, I’ll need to simulate the application behavior in the tests:</p>
<ul>
<li><p>Create a reactive <code>data()</code> input in <code>selectVarServer()</code>:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>setting args = list()</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>  <span class="fu">testServer</span>(selectVarServer,</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">args =</span> <span class="fu">list</span>(<span class="at">data =</span> <span class="fu">reactive</span>(chickwts),</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>                <span class="at">filter =</span> is.numeric), <span class="at">expr =</span> {</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># include expectations below...</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>  })</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div></li>
<li><p>Set the <code>input$var</code> and verify the <code>input$var</code>:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>verify input$var</summary>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>  session<span class="sc">$</span><span class="fu">setInputs</span>(<span class="at">var =</span> <span class="st">"weight"</span>)</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(<span class="at">object =</span> input<span class="sc">$</span>var,</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>      <span class="at">expected =</span> <span class="st">"weight"</span>)</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">test_cmt</span>(<span class="st">"selectVarServer"</span>, <span class="st">"input$var"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div></li>
<li><p>Set the <code>input$var</code> and verify the <code>session$returned()</code></p>
<div class="cell">
<details open="" class="code-fold">
<summary>verify session$returned()</summary>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>  session<span class="sc">$</span><span class="fu">setInputs</span>(<span class="at">var =</span> <span class="st">"feed"</span>)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(<span class="at">object =</span> session<span class="sc">$</span><span class="fu">returned</span>(),</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">expected =</span> chickwts[[<span class="st">"feed"</span>]])</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">test_cmt</span>(<span class="st">"selectVarServer"</span>, <span class="st">"session$returned()"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div></li>
</ul>
</section>
</section>
<section id="module-outputs" class="level3">
<h3 class="anchored" data-anchor-id="module-outputs">Module outputs</h3>
<p>Rendered outputs can be accessed in <code>testServer()</code> just like inputs (i.e., with <code>output$outputId</code>). But the modules in <code>mstsap</code> don’t have outputs–these are included in the standalone app functions (<code>datasetApp()</code>, <code>selectVarApp()</code>, and <code>selectDaraVarApp()</code>).</p>
<p>Fortunately, app functions can also be passed to the <code>app</code> argument of <code>testServer()</code>. I’ll use <code>datasetApp()</code> to demonstrate.</p>
<div>

</div>
<div class="quarto-layout-panel" data-layout="[65,35]">
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="quarto-layout-cell" style="flex-basis: 65.0%;justify-content: center;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="datasetApp.png" class="lightbox" data-gallery="quarto-lightbox-gallery-15"><img src="datasetApp.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></a></p>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 35.0%;justify-content: flex-start;">
<div class="sourceCode" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>ds_app <span class="ot">&lt;-</span> <span class="fu">datasetApp</span>()</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">testServer</span>(ds_app, </span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">expr =</span> {</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>  })</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<p>Testing a standalone app function is similar to testing a module server function, but with a few minor differences. First, the output from the standalone app function is <a href="https://shiny.posit.co/r/articles/improve/server-function-testing/#shiny-app-objects">assigned to an object</a> (<code>ds_app</code>), then placed in the <code>app</code> argument.</p>
<p>To use <code>session$setInputs()</code> need to include the namespace for the <code>inputId</code>. The output from <code>reactiveValuesToList()</code> in <code>datasetApp()</code> shows me how to access the <code>inputId</code> in the <code>datasetServer()</code> module (i.e., <code>input$`dataset-dataset`</code>):</p>
<div>

</div>
<div class="quarto-layout-panel" data-layout="[65,35]">
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="quarto-layout-cell" style="flex-basis: 65.0%;justify-content: center;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="datasetApp_reactives.png" class="lightbox" data-gallery="quarto-lightbox-gallery-16"><img src="datasetApp_reactives.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></a></p>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 35.0%;justify-content: flex-start;">
<div class="sourceCode" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>ds_app <span class="ot">&lt;-</span> <span class="fu">datasetApp</span>()</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="fu">testServer</span>(ds_app, </span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="at">expr =</span> {</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>  session<span class="sc">$</span><span class="fu">setInputs</span>(</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">dataset-dataset</span><span class="st">`</span> <span class="ot">=</span> <span class="st">"chickwts"</span>)</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<p>Testing outputs with <code>testServer()</code> is different than testing outputs in regular unit tests, because Shiny outputs are executed in the server, but then rendered as HTML in the UI. <code>testServer()</code> <a href="https://shiny.posit.co/r/articles/improve/server-function-testing/#complex-outputs-plots-htmlwidgets">outlines</a> a testing strategy for complex outputs:</p>
<blockquote class="blockquote">
<p>*The goal for your tests should be to ask “is the code that I wrote producing the plot I want?” There are two components to that question:</p>
<ol type="1">
<li><em>Does the plot generate without producing an error?</em></li>
<li><em>Is the plot visually correct?</em></li>
</ol>
<p><em><code>testServer</code> is great for assessing the first component here. By merely referencing <code>output$plot</code> in your test, you’ll confirm that the plot was generated without an error.</em></p>
</blockquote>
<p>If we replace <em>plot</em> with <em>table</em> in the advice above, the tests for <code>datasetApp()</code> should confirm <code>output$data</code> is generated without producing an error.</p>
<p>Instead of writing an expectation, we’ll use <code>cat()</code> to display the contents of <code>output$data</code> after setting the <code>`dataset-dataset`</code> input:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>ds_app <span class="ot">&lt;-</span> <span class="fu">datasetApp</span>()</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="fu">testServer</span>(ds_app, <span class="at">expr =</span> {</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  session<span class="sc">$</span><span class="fu">setInputs</span>(<span class="st">`</span><span class="at">dataset-dataset</span><span class="st">`</span> <span class="ot">=</span> <span class="st">"chickwts"</span>)</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\t</span><span class="st">output$data:</span><span class="sc">\n</span><span class="st">"</span>, output<span class="sc">$</span>data, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The results from the test is below:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">test_file</span>(<span class="st">"tests/testthat/test-datasetApp.R"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="sourceCode" id="cb46"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>[ FAIL 0 | WARN 0 | SKIP 0 | PASS 0 ]</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>    output$data:</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb47"><pre class="sourceCode html code-with-copy"><code class="sourceCode html"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a> <span class="dt">&lt;</span><span class="kw">table</span><span class="ot">  class </span><span class="op">=</span> <span class="st">'table shiny-table table- spacing-s'</span><span class="ot"> style </span><span class="op">=</span> <span class="st">'width:auto;'</span><span class="dt">&gt;</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">thead</span><span class="dt">&gt;</span> </span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&lt;</span><span class="kw">tr</span><span class="dt">&gt;</span> </span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&lt;</span><span class="kw">th</span><span class="ot"> style</span><span class="op">=</span><span class="st">'text-align: right;'</span><span class="dt">&gt;</span> weight <span class="dt">&lt;/</span><span class="kw">th</span><span class="dt">&gt;</span> </span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&lt;</span><span class="kw">th</span><span class="ot"> style</span><span class="op">=</span><span class="st">'text-align: left;'</span><span class="dt">&gt;</span> feed <span class="dt">&lt;/</span><span class="kw">th</span><span class="dt">&gt;</span>  </span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>     <span class="dt">&lt;/</span><span class="kw">tr</span><span class="dt">&gt;</span> </span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;/</span><span class="kw">thead</span><span class="dt">&gt;</span> </span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&lt;</span><span class="kw">tbody</span><span class="dt">&gt;</span></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&lt;</span><span class="kw">tr</span><span class="dt">&gt;</span> <span class="dt">&lt;</span><span class="kw">td</span><span class="ot"> align</span><span class="op">=</span><span class="st">"right"</span><span class="dt">&gt;</span> 179.00 <span class="dt">&lt;/</span><span class="kw">td</span><span class="dt">&gt;</span> <span class="dt">&lt;</span><span class="kw">td</span><span class="dt">&gt;</span> horsebean <span class="dt">&lt;/</span><span class="kw">td</span><span class="dt">&gt;</span> <span class="dt">&lt;/</span><span class="kw">tr</span><span class="dt">&gt;</span></span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&lt;</span><span class="kw">tr</span><span class="dt">&gt;</span> <span class="dt">&lt;</span><span class="kw">td</span><span class="ot"> align</span><span class="op">=</span><span class="st">"right"</span><span class="dt">&gt;</span> 160.00 <span class="dt">&lt;/</span><span class="kw">td</span><span class="dt">&gt;</span> <span class="dt">&lt;</span><span class="kw">td</span><span class="dt">&gt;</span> horsebean <span class="dt">&lt;/</span><span class="kw">td</span><span class="dt">&gt;</span> <span class="dt">&lt;/</span><span class="kw">tr</span><span class="dt">&gt;</span></span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&lt;</span><span class="kw">tr</span><span class="dt">&gt;</span> <span class="dt">&lt;</span><span class="kw">td</span><span class="ot"> align</span><span class="op">=</span><span class="st">"right"</span><span class="dt">&gt;</span> 136.00 <span class="dt">&lt;/</span><span class="kw">td</span><span class="dt">&gt;</span> <span class="dt">&lt;</span><span class="kw">td</span><span class="dt">&gt;</span> horsebean <span class="dt">&lt;/</span><span class="kw">td</span><span class="dt">&gt;</span> <span class="dt">&lt;/</span><span class="kw">tr</span><span class="dt">&gt;</span></span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&lt;</span><span class="kw">tr</span><span class="dt">&gt;</span> <span class="dt">&lt;</span><span class="kw">td</span><span class="ot"> align</span><span class="op">=</span><span class="st">"right"</span><span class="dt">&gt;</span> 227.00 <span class="dt">&lt;/</span><span class="kw">td</span><span class="dt">&gt;</span> <span class="dt">&lt;</span><span class="kw">td</span><span class="dt">&gt;</span> horsebean <span class="dt">&lt;/</span><span class="kw">td</span><span class="dt">&gt;</span> <span class="dt">&lt;/</span><span class="kw">tr</span><span class="dt">&gt;</span></span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&lt;</span><span class="kw">tr</span><span class="dt">&gt;</span> <span class="dt">&lt;</span><span class="kw">td</span><span class="ot"> align</span><span class="op">=</span><span class="st">"right"</span><span class="dt">&gt;</span> 217.00 <span class="dt">&lt;/</span><span class="kw">td</span><span class="dt">&gt;</span> <span class="dt">&lt;</span><span class="kw">td</span><span class="dt">&gt;</span> horsebean <span class="dt">&lt;/</span><span class="kw">td</span><span class="dt">&gt;</span> <span class="dt">&lt;/</span><span class="kw">tr</span><span class="dt">&gt;</span></span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&lt;</span><span class="kw">tr</span><span class="dt">&gt;</span> <span class="dt">&lt;</span><span class="kw">td</span><span class="ot"> align</span><span class="op">=</span><span class="st">"right"</span><span class="dt">&gt;</span> 168.00 <span class="dt">&lt;/</span><span class="kw">td</span><span class="dt">&gt;</span> <span class="dt">&lt;</span><span class="kw">td</span><span class="dt">&gt;</span> horsebean <span class="dt">&lt;/</span><span class="kw">td</span><span class="dt">&gt;</span> <span class="dt">&lt;/</span><span class="kw">tr</span><span class="dt">&gt;</span></span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a>   <span class="dt">&lt;/</span><span class="kw">tbody</span><span class="dt">&gt;</span> </span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a> <span class="dt">&lt;/</span><span class="kw">table</span><span class="dt">&gt;</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The output is the HTML used to render the table in the UI. This doesn’t add a passing test, but it confirms that the table is being generated from the <code>data()</code> reactive.</p>
<p>The tests for <code>datasetApp()</code> will confirm the <code>inputId</code>, and verify the <code>class</code> and <code>names</code> of the <code>data()</code> reactive (which will be passed to the <code>renderTable()</code> function):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">object =</span> input<span class="sc">$</span><span class="st">`</span><span class="at">dataset-dataset</span><span class="st">`</span>,</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">expected =</span> <span class="st">"chickwts"</span>)</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">test_cmt</span>(<span class="st">"datasetApp"</span>, <span class="st">"input$`dataset-dataset`"</span>)</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_true</span>(</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">object =</span> <span class="fu">is.data.frame</span>(<span class="fu">data</span>()))</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">test_cmt</span>(<span class="st">"datasetApp"</span>, <span class="st">"is.data.frame(data())"</span>)</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(</span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">object =</span> <span class="fu">names</span>(<span class="fu">data</span>()),</span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">expected =</span> <span class="fu">names</span>(datasets<span class="sc">::</span>chickwts))</span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">test_cmt</span>(<span class="st">"datasetApp"</span>, <span class="st">"names(data())"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>I can include a test for the <code>class</code> of <code>output$data</code>, but note that this is a character output:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="fu">expect_equal</span>(</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">object =</span> <span class="fu">class</span>(output<span class="sc">$</span>data),</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">expected =</span> <span class="st">"character"</span>)</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="fu">test_cmt</span>(<span class="st">"datasetApp"</span>, <span class="st">"class(output$data)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The same method can be used to test the <code>selectVarApp()</code>, but note this app requires passing both <code>inputId</code>s to <code>session$setInputs()</code>:</p>
<div class="cell">
<details class="code-fold">
<summary>show/hide selectVarApp() tests</summary>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>sv_app <span class="ot">&lt;-</span> <span class="fu">selectVarApp</span>()</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="fu">testServer</span>(<span class="at">app =</span> sv_app, <span class="at">expr =</span> {</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>  session<span class="sc">$</span><span class="fu">setInputs</span>(<span class="st">`</span><span class="at">var-var</span><span class="st">`</span> <span class="ot">=</span> <span class="st">"Ozone"</span>,</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>                    <span class="st">`</span><span class="at">data-dataset</span><span class="st">`</span> <span class="ot">=</span> <span class="st">"airquality"</span>)</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># confirm contents of output$out</span></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\t</span><span class="st">output$out:</span><span class="sc">\n</span><span class="st">"</span>, output<span class="sc">$</span>out, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># confirm var is reactive </span></span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_true</span>(<span class="at">object =</span> <span class="fu">is.reactive</span>(var))</span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># confirm var input</span></span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(</span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">object =</span> input<span class="sc">$</span><span class="st">`</span><span class="at">var-var</span><span class="st">`</span>,</span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">expected =</span> <span class="st">"Ozone"</span>)</span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># confirm data is reactive</span></span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_true</span>(<span class="at">object =</span> <span class="fu">is.reactive</span>(data))</span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># confirm data() is a data.frame</span></span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_true</span>(</span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">object =</span> <span class="fu">is.data.frame</span>(<span class="fu">data</span>()))</span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># confirm 'data' can be subsetted with 'var'</span></span>
<span id="cb50-20"><a href="#cb50-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(</span>
<span id="cb50-21"><a href="#cb50-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">object =</span> <span class="fu">data</span>()[[input<span class="sc">$</span><span class="st">`</span><span class="at">var-var</span><span class="st">`</span>]],</span>
<span id="cb50-22"><a href="#cb50-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">expected =</span> airquality[[<span class="st">"Ozone"</span>]])</span>
<span id="cb50-23"><a href="#cb50-23" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="testing-nested-modules" class="level4">
<h4 class="anchored" data-anchor-id="testing-nested-modules">Testing nested modules</h4>
<p>I highly recommend viewing the output of <code>reactiveValuesToList()</code> if your application has nested modules. It’s easy to lose track of ids if they span multiple layers.</p>
<p>We know <code>selectDataVarApp()</code> contains ‘modules inside other modules’, and these layers are reflected in the namespaces:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="selectDataVarApp_reactives.png" class="lightbox" data-gallery="quarto-lightbox-gallery-17"><img src="selectDataVarApp_reactives.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%"></a></p>
</figure>
</div>
<p>To access the <code>inputId</code>s in the nested modules, we need to pass the full ‘appended’ namespace:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>dv_app <span class="ot">&lt;-</span> <span class="fu">selectDataVarApp</span>()</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="fu">testServer</span>(<span class="at">app =</span> dv_app, <span class="at">expr =</span> {</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>  session<span class="sc">$</span><span class="fu">setInputs</span>(<span class="st">`</span><span class="at">var-var-var</span><span class="st">`</span> <span class="ot">=</span> <span class="st">"Ozone"</span>,</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>                    <span class="st">`</span><span class="at">var-data-dataset</span><span class="st">`</span> <span class="ot">=</span> <span class="st">"airquality"</span>)</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>After setting the inputs, I can confirm the contents of <code>output$out</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>dv_app <span class="ot">&lt;-</span> <span class="fu">selectDataVarApp</span>()</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="fu">testServer</span>(<span class="at">app =</span> dv_app, <span class="at">expr =</span> {</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>  session<span class="sc">$</span><span class="fu">setInputs</span>(<span class="st">`</span><span class="at">var-var-var</span><span class="st">`</span> <span class="ot">=</span> <span class="st">"Ozone"</span>,</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>                    <span class="st">`</span><span class="at">var-data-dataset</span><span class="st">`</span> <span class="ot">=</span> <span class="st">"airquality"</span>)</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\t</span><span class="st">output$out:</span><span class="sc">\n</span><span class="st">"</span>, output<span class="sc">$</span>out, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="fu">test_file</span>(<span class="st">"tests/testthat/test-selectDataVarApp.R"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="sourceCode" id="cb54"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>[ FAIL 0 | WARN 0 | SKIP 0 | PASS 0 ]</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>    output$out:</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>   [1]  41  36  12  18  NA  28  23  19   8  NA   7  16  11  14  18</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a> [16]  14  34   6  30  11   1  11   4  32  NA  NA  NA  23  45 115</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a> [31]  37  NA  NA  NA  NA  NA  NA  29  NA  71  39  NA  NA  23  NA</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a> [46]  NA  21  37  20  12  13  NA  NA  NA  NA  NA  NA  NA  NA  NA</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a> [61]  NA 135  49  32  NA  64  40  77  97  97  85  NA  10  27  NA</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a> [76]   7  48  35  61  79  63  16  NA  NA  80 108  20  52  82  50</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a> [91]  64  59  39   9  16  78  35  66 122  89 110  NA  NA  44  28</span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>[106]  65  NA  22  59  23  31  44  21   9  NA  45 168  73  NA  76</span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>[121] 118  84  85  96  78  73  91  47  32  20  23  21  24  44  21</span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>[136]  28   9  13  46  18  13  24  16  13  23  36   7  14  30  NA</span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>[151]  14  18  20 </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>After confirming <code>output$out</code>, I’ll test the inputs:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">object =</span> input<span class="sc">$</span><span class="st">`</span><span class="at">var-var-var</span><span class="st">`</span>,</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">expected =</span> <span class="st">"Ozone"</span>)</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">test_cmt</span>(<span class="st">"selectDataVarApp"</span>, <span class="st">"input$`var-var-var`"</span>)</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">object =</span> input<span class="sc">$</span><span class="st">`</span><span class="at">var-data-dataset</span><span class="st">`</span>,</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">expected =</span> <span class="st">"airquality"</span>)</span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">test_cmt</span>(<span class="st">"selectDataVarApp"</span>, <span class="st">"input$`var-data-dataset`"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>I can also verify the contents of the reactive <code>var()</code> inside the test:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_true</span>(<span class="at">object =</span> <span class="fu">is.reactive</span>(var))</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">test_cmt</span>(<span class="st">"selectDataVarApp"</span>, <span class="st">"is.reactive(var)"</span>)</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\t</span><span class="st">var:</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">var</span>(), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="fu">test_file</span>(<span class="st">"tests/testthat/test-selectDataVarApp.R"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="sourceCode" id="cb58"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>[ FAIL 0 | WARN 0 | SKIP 0 | PASS 3 ]</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>       selectDataVarApp: is.reactive(var) </span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>    var:</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a> 41 36 12 18 NA 28 23 19 8 NA 7 16 11 14 18 14 34 6 30 11 1 11 4 32 NA NA NA 23 </span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>    45 115 37 NA NA NA NA NA NA 29 NA 71 39 NA NA 23 NA NA 21 37 20 12 13 NA NA NA</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>    NA NA NA NA NA NA NA 135 49 32 NA 64 40 77 97 97 85 NA 10 27 NA 7 48 35 61 79 </span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>    63 16 NA NA 80 108 20 52 82 50 64 59 39 9 16 78 35 66 122 89 110 NA NA 44 28 </span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>    65 NA 22 59 23 31 44 21 9 NA 45 168 73 NA 76 118 84 85 96 78 73 91 47 32 20 23</span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>    21 24 44 21 28 9 13 46 18 13 24 16 13 23 36 7 14 30 NA 14 18 20 </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
</section>
<section id="recap" class="level2">
<h2 class="anchored" data-anchor-id="recap">Recap</h2>
<p>This post has shown how shiny’s <code>testServer()</code> function allows you to isolate and test module server functions, which makes it easier to ensure that your <code>server</code> function behaves as expected (and locate and fix bugs).</p>
<p>I hope you have a better understanding of how you can use <code>testServer()</code> to test a modules inputs/outputs, reactivity, calculations, and errors.</p>
<p>In the next post I’ll cover performing integration tests with <code>shinytest2</code>!</p>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Specifically, the applications come from sections <a href="https://mastering-shiny.org/scaling-modules.html#inputs-and-outputs">19.3</a> through <a href="https://mastering-shiny.org/scaling-modules.html#modules-inside-of-modules">19.3.4</a>.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>The help files for <code>NS()</code> include the following description for a module namespace: “<em>a namespace is to an ID as a directory is to a file.</em>”<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/mjfrigaard\.github\.io\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      const annoteTargets = window.document.querySelectorAll('.code-annotation-anchor');
      for (let i=0; i<annoteTargets.length; i++) {
        const annoteTarget = annoteTargets[i];
        const targetCell = annoteTarget.getAttribute("data-target-cell");
        const targetAnnotation = annoteTarget.getAttribute("data-target-annotation");
        const contentFn = () => {
          const content = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          if (content) {
            const tipContent = content.cloneNode(true);
            tipContent.classList.add("code-annotation-tip-content");
            return tipContent.outerHTML;
          }
        }
        const config = {
          allowHTML: true,
          content: contentFn,
          onShow: (instance) => {
            selectCodeLines(instance.reference);
            instance.reference.classList.add('code-annotation-active');
            window.tippy.hideAll();
          },
          onHide: (instance) => {
            unselectCodeLines();
            instance.reference.classList.remove('code-annotation-active');
          },
          maxWidth: 300,
          delay: [50, 0],
          duration: [200, 0],
          offset: [5, 10],
          arrow: true,
          appendTo: function(el) {
            return el.parentElement.parentElement.parentElement;
          },
          interactive: true,
          interactiveBorder: 10,
          theme: 'quarto',
          placement: 'right',
          popperOptions: {
            modifiers: [
            {
              name: 'flip',
              options: {
                flipVariations: false, // true by default
                allowedAutoPlacements: ['right'],
                fallbackPlacements: ['right', 'top', 'top-start', 'top-end', 'bottom', 'bottom-start', 'bottom-end', 'left'],
              },
            },
            {
              name: 'preventOverflow',
              options: {
                mainAxis: false,
                altAxis: false
              }
            }
            ]        
          }      
        };
        window.tippy(annoteTarget, config); 
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<script>var lightboxQuarto = GLightbox({"closeEffect":"zoom","descPosition":"bottom","loop":false,"openEffect":"zoom","selector":".lightbox"});
(function() {
  let previousOnload = window.onload;
  window.onload = () => {
    if (previousOnload) {
      previousOnload();
    }
    lightboxQuarto.on('slide_before_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      const href = trigger.getAttribute('href');
      if (href !== null) {
        const imgEl = window.document.querySelector(`a[href="${href}"] img`);
        if (imgEl !== null) {
          const srcAttr = imgEl.getAttribute("src");
          if (srcAttr && srcAttr.startsWith("data:")) {
            slideConfig.href = srcAttr;
          }
        }
      } 
    });
  
    lightboxQuarto.on('slide_after_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(slideNode);
      }
    });
  
  };
  
})();
          </script>




</body></html>